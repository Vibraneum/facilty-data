<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ixora Facility Management - Police Stations Hyderabad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MAPBOX GL JS - Updated to specific working version -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --primary-color: #0056b3;
      --primary-light: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --body-bg: #f8f9fa;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition-speed: 0.3s;
      --primary-light-rgb: 0, 123, 255;

      /* Category colors */
      --vip-color: #ff4500;
      --platinum-color: #e5e4e2;
      --gold-color: #ffd700;
      --silver-color: #c0c0c0;

      /* Site type colors */
      --hyderabad-color: #3366cc;
      --cyberabad-color: #0099c6;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--body-bg);
      color: var(--dark-color);
    }

    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .header {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
      padding: 15px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      max-width: 90%;
      text-align: center;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header img {
      height: 40px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .sidebar {
      position: absolute;
      top: 80px;
      left: 20px;
      bottom: 20px;
      width: 300px;
      z-index: 1000;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow-y: auto;
      transition: transform var(--transition-speed), background-color var(--transition-speed);
      transform: translateX(0);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .sidebar-content {
      padding: 20px;
    }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background-color: var(--primary-light);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 10;
      transition: transform 0.2s ease;
    }
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    .sidebar.collapsed {
      transform: translateX(-340px);
    }

    .filter-section {
      margin-bottom: 24px;
    }
    .filter-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      transition: color var(--transition-speed);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-section h3 i {
      color: var(--primary-light);
    }
    .checkbox-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.2s ease;
    }
    .checkbox-item:hover {
      transform: translateX(5px);
    }
    .custom-checkbox {
      position: relative;
      display: flex;
      align-items: center;
    }
    .custom-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    .checkmark {
      height: 20px;
      width: 20px;
      background-color: #eee;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .custom-checkbox:hover input ~ .checkmark {
      background-color: #ccc;
    }
    .custom-checkbox input:checked ~ .checkmark {
      background-color: var(--primary-light);
    }
    .checkmark:after {
      content: "\f00c";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      display: none;
      font-size: 12px;
    }
    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #search-bar {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      background-color: var(--light-color);
      color: var(--dark-color);
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    #search-bar:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(var(--primary-light-rgb), 0.25);
    }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary-color);
    }

    /* Legend styles - improved positioning and interaction */
    .legend {
      position: absolute;
      bottom: 90px;
      right: 20px;
      z-index: 900;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .legend h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
    }

    /* Add legend minimize button */
    .legend-minimize {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s ease;
    }

    .legend-minimize:hover {
      background-color: var(--primary-light);
      color: white;
    }

    .legend.minimized {
      transform: translateY(calc(100% - 40px));
      height: 40px;
      max-height: 40px;
      overflow: hidden;
    }

    .legend.minimized h3 {
      margin: 0;
      padding: 0;
      border: none;
    }

    .legend.minimized .legend-section {
      display: none;
    }

    /* Your existing legend styles - preserved */
    .legend-section {
      margin-bottom: 15px;
    }

    .legend-item, .legend-tier-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      transition: transform 0.2s ease;
    }

    .legend-item:hover, .legend-tier-item:hover {
      transform: translateX(5px);
    }

    .legend-color, .legend-tier-icon {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      flex-shrink: 0;
      transition: transform 0.2s ease;
      border: 2px solid white;
    }

    .legend-color:hover, .legend-tier-icon:hover {
      transform: scale(1.1);
    }

    .type-hyderabad-police { background-color: var(--hyderabad-color); }
    .type-cyberabad-police { background-color: var(--cyberabad-color); }
    .tier-vip { background: linear-gradient(135deg, var(--vip-color), #ff6347); color: white; }
    .tier-platinum { background: linear-gradient(135deg, var(--platinum-color), #ffffff); color: #333; }
    .tier-gold { background: linear-gradient(135deg, var(--gold-color), #FFF7CC); color: #333; }
    .tier-silver { background: linear-gradient(135deg, var(--silver-color), #E6E6E6); color: #333; }

    /* Improve map controls positioning to avoid overlap with legend */
    .mapboxgl-ctrl-top-right {
      top: 20px !important;
      right: 20px !important;
    }

    .mapboxgl-ctrl-bottom-right {
      bottom: 20px !important;
      right: 20px !important;
    }
    /* VIP Popup styling */
    .custom-popup {
      max-width: 350px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      color: var(--dark-color);
    }
    .custom-popup h3 {
      margin: 0 0 12px 0;
      color: var(--dark-color);
      font-size: 18px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .site-type-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      margin-right: 10px;
      flex-shrink: 0;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .popup-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .popup-stat-card {
      background-color: rgba(var(--primary-light-rgb), 0.1);
      border-radius: var(--border-radius);
      padding: 12px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(var(--primary-light-rgb), 0.2);
    }
    .popup-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .popup-stat-icon {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--primary-light);
    }
    .popup-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--dark-color);
    }
    .popup-stat-label {
      font-size: 12px;
      color: var(--secondary-color);
      margin-top: 3px;
    }
    
    .popup-header-info {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .popup-tier-badge {
      background-color: var(--light-color);
      border-radius: 20px;
      padding: 3px 8px;
      font-size: 12px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }
    
    .popup-tier-badge.vip {
      background-color: var(--vip-color);
      color: white;
    }
    
    .popup-tier-badge.platinum {
      background-color: var(--platinum-color);
      color: #333;
    }
    
    .popup-tier-badge.gold {
      background-color: var(--gold-color);
      color: #333;
    }
    
    .popup-tier-badge.silver {
      background-color: var(--silver-color);
      color: #333;
    }

    .popup-address {
      background-color: rgba(var(--primary-light-rgb), 0.05);
      padding: 12px;
      border-radius: var(--border-radius);
      margin-top: 10px;
      font-size: 14px;
      border-left: 3px solid var(--primary-light);
    }
    
    .popup-address i {
      color: var(--primary-light);
      margin-right: 5px;
    }

    .loader-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-light);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 500;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    // Custom Mapbox marker styles - Enhanced for visibility
    .mapboxgl-marker {
      transition: transform 0.3s ease;
      z-index: 100 !important; /* Ensure markers are above other map elements */
    }
    .mapboxgl-marker:hover {
      transform: scale(1.2);
      z-index: 200 !important;
    }
    
    .custom-marker {
      width: 40px; /* Larger size */
      height: 40px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 18px; /* Larger text */
      box-shadow: 0 3px 10px rgba(0,0,0,0.6); /* More pronounced shadow */
      border: 3px solid white; /* Thicker border */
      cursor: pointer;
      transition: transform 0.3s ease;
      position: relative;
    }
    
    .custom-marker:hover {
      transform: scale(1.2);
      box-shadow: 0 5px 15px rgba(0,0,0,0.7);
    }
    
    .custom-marker.hyderabad-police {
      background-color: #3366cc;
    }
    
    .custom-marker.cyberabad-police {
      background-color: #0099c6;
    }
    
    /* Category indicators with enhanced visibility */
    .custom-marker.vip::after,
    .custom-marker.platinum::after,
    .custom-marker.gold::after,
    .custom-marker.silver::after {
      content: "";
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px; /* Larger indicator */
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 50;
    }
    
    .custom-marker.vip::after {
      background-color: #ff4500;
    }
    
    .custom-marker.platinum::after {
      background-color: #e5e4e2;
    }
    
    .custom-marker.gold::after {
      background-color: #ffd700;
    }
    
    .custom-marker.silver::after {
      background-color: #c0c0c0;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .status-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .status-indicator i {
      color: var(--success-color);
    }
    
    .status-indicator.error i {
      color: var(--danger-color);
    }

    /* Responsive & smaller screens */
    @media (max-width: 768px) {
      .header {
        width: calc(100% - 40px);
        padding: 10px 15px;
      }
      .sidebar {
        width: 250px;
      }
      .legend {
        bottom: 10px;
        right: 10px;
        width: 200px;
      }
    }
    @media (max-width: 576px) {
      .header h1 {
        font-size: 16px;
      }
      .header img {
        height: 30px;
      }
      .sidebar.collapsed {
        transform: translateX(-240px);
      }
    }
  </style>
</head>

<body>
  <div id="map-container">
    <!-- Loader -->
    <div class="loader-container" id="loader">
      <div class="loader"></div>
      <div class="loader-text">Loading facility data...</div>
    </div>

    <!-- Header -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/Vibraneum/facilty-data/refs/heads/main/Ixora%20FM%20logo.png" alt="Ixora FM Logo">
      <h1>Ixora Facility Management - Police Stations Hyderabad</h1>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </div>
      <div class="sidebar-content">
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="Search by site name...">
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-filter"></i> Site Types</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="hyderabad-police" checked data-type="hyderabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Hyderabad Police</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="cyberabad-police" checked data-type="cyberabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Cyberabad Police</span>
            </div>
          </div>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-medal"></i> Site Category</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="vip-tier" checked data-tier="vip"/>
                <span class="checkmark"></span>
              </label>
              <span>VIP</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="platinum-tier" checked data-tier="platinum"/>
                <span class="checkmark"></span>
              </label>
              <span>Platinum</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="gold-tier" checked data-tier="gold"/>
                <span class="checkmark"></span>
              </label>
              <span>Gold</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="silver-tier" checked data-tier="silver"/>
                <span class="checkmark"></span>
              </label>
              <span>Silver</span>
            </div>
          </div>
        </div>
        
        <div class="filter-section">
          <h3><i class="fas fa-info-circle"></i> Statistics</h3>
          <div id="stats-container">
            Loading statistics...
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend" id="legend">
      <div class="legend-section">
        <h3>Site Types</h3>
        <div class="legend-item">
          <div class="legend-color type-hyderabad-police">
            <i class="fas fa-shield-alt"></i>
          </div>
          <span>Hyderabad Police</span>
        </div>
        <div class="legend-item">
          <div class="legend-color type-cyberabad-police">
            <i class="fas fa-laptop-code"></i>
          </div>
          <span>Cyberabad Police</span>
        </div>
      </div>
      
      <!-- Map Style Controls -->
      <div class="legend-section">
        <h3>Map Style</h3>
        <div id="map-styles" class="checkbox-container">
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="streets-v11" type="radio" name="rtoggle" checked="checked">
              <span class="checkmark"></span>
            </label>
            <span>Streets</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="light-v10" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Light</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="dark-v10" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Dark</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="satellite-v9" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Satellite</span>
          </div>
        </div>
      </div>
    <!-- "Load Sample Data" is now "Reload All Data" -->
      <div class="legend-section" style="margin: 20px 0; text-align: center;">
        <button id="load-sample-data" style="background-color: #007bff; color: white; 
               border: none; padding: 12px 15px; border-radius: 4px; cursor: pointer;
               width: 100%; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
               font-size: 14px; display: flex; align-items: center; justify-content: center;
               gap: 8px;">
          <i class="fas fa-sync-alt" style="font-size: 18px;"></i> 
          <span>RELOAD ALL DATA</span>
        </button>
        <div style="font-size: 12px; margin-top: 5px; color: #555;">
          Shows all 274 facilities
        </div>
      </div>
      
      <div class="legend-section">
        <h3>Site Categories</h3>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-vip">V</div>
          <span>VIP Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-platinum">P</div>
          <span>Platinum Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-gold">G</div>
          <span>Gold Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-silver">S</div>
          <span>Silver Tier</span>
        </div>
      </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="status-indicator" id="status-indicator">
      <i class="fas fa-check-circle"></i>
      <span id="status-text">Data loaded successfully</span>
    </div>

    <div id="map"></div>
  </div>


<!-- Replace the entire script section in your HTML with this -->
<script>
    // Use your actual Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoidmVkYW50aG5hdGgiLCJhIjoiY203c3lsOWZyMGs4MzJpcmJoZTY1Ync4bSJ9.Hx83V0-qM8JOmh4y_SSXCw';

    // Sample VIP data for enrichment when needed
    const sampleVIPData = {
      "OFFICE OF THE COMMISSIONER OF POLICE(OLD)": { staff: 220, chemicals: 450, wasteVehicles: 10, machines: 20 },
      "SAIFABAD": { staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
      "BEGUMPET": { staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
      "CHARMINAR": { staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 }
      // You can add more entries as needed
    };

    // Hard-coded sample data for immediate fallback
    const EMERGENCY_DATA = [
      { siteName: "Saifabad Police Station", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004", staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
      { siteName: "Begumpet Police Station", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016", staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
      { siteName: "Charminar Police Station", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002", staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 },
      { siteName: "Jubilee Hills Police Station", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
      { siteName: "Gachibowli Police Station", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
      { siteName: "Kukatpally Police Station", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
      { siteName: "Uppal Police Station", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
      { siteName: "Miyapur Police Station", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
      { siteName: "Madhapur Police Station", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
      { siteName: "LB Nagar Police Station", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" }
    ];

    // UI Elements
    const loader = document.getElementById('loader');
    const sidebar = document.getElementById('sidebar');
    const sidebarTgl = document.getElementById('sidebar-toggle');
    const searchBar = document.getElementById('search-bar');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const statsContainer = document.getElementById('stats-container');

    // Initialize with NO failsafe timer
    let rawData = null;        // store fetched JSON
    let currentPopup = null;   // track open popup
    let markers = [];          // store all markers
    let visibleMarkers = [];   // track which markers are visible
    let mapInitialized = false; // track if map is fully initialized

    // Create the map with improved style
    console.log('Initializing map...');
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11', // Streets style for better visibility
      center: [78.4867, 17.3850], // Hyderabad center
      zoom: 11,
      pitch: 0, // Reduce 3D effects for stability
      bearing: 0
    });

    // Make sure mapboxgl is defined
    if (typeof mapboxgl === 'undefined') {
      console.error('Mapbox GL JS is not loaded. Check your internet connection or try a different browser.');
      alert('Mapbox GL JS failed to load. Please check your internet connection and reload the page.');
    }
    
    // Set a global timeout to ensure we show data even if all fetches fail
    const globalTimeoutId = setTimeout(() => {
      console.warn('Global timeout reached, forcing sample data load');
      // If loader is still visible, it means data hasn't loaded yet
      if (loader.style.display !== 'none') {
        document.getElementById('load-sample-data').click();
      }
    }, 10000); // 10 second global timeout

    // Handle potential map initialization errors
    try {
      // Do an immediate load of sample data if needed
      const urlParams = new URLSearchParams(window.location.search);
      const directLoad = urlParams.get('load') === 'sample';
      
      map.on('load', () => {
        console.log('Map has loaded. Setting up...');
        
        // Create a debug status display
        showStatus('Map loaded successfully. Setting up controls...', 'success');
        
        // Add navigation controls with improved positioning
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        
        // Add fullscreen control
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
        
        // Add geolocate control
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: {enableHighAccuracy: true},
            trackUserLocation: true,
            showUserHeading: true
          }), 
          'top-right'
        );
        
        // Check if we should immediately load sample data (for testing)
        if (directLoad) {
          console.log('Direct sample data loading triggered by URL parameter');
          setTimeout(() => {
            document.getElementById('load-sample-data').click();
          }, 1000);
        } else {
          // Fetch data normally
          fetchDataAndBuildLayers();
        }
      });
      
      // Add map style change event handler
      map.on('style.load', () => {
        console.log('Map style loaded/changed');
        
        // If we have markers but changed style, recreate them to ensure visibility
        if (markers.length > 0 && rawData) {
          console.log('Recreating markers after style change');
          setTimeout(() => createDirectMarkers(rawData), 500);
        }
      });
    } catch (error) {
      console.error('Error initializing map:', error);
      alert('Failed to initialize the map. Please try refreshing the page or use the "Load Sample Data" button.');
    }

    // Fixed: fetchWithFallback function now returns a proper Promise
    function fetchWithFallback(urls, index = 0) {
      return new Promise((resolve, reject) => {
        if (index >= urls.length) {
          console.error('All URLs failed, using sample data');
          resolve(generateSampleData());
          return;
        }
        
        console.log(`Trying URL ${index + 1}/${urls.length}: ${urls[index]}`);
        
        // Add a timeout to prevent hanging
        const timeoutId = setTimeout(() => {
          console.warn(`Fetch timeout for ${urls[index]}`);
          fetchWithFallback(urls, index + 1)
            .then(resolve)
            .catch(reject);
        }, 5000); // 5 second timeout
        
        fetch(urls[index], {
          headers: {
            'Accept': 'application/json'
          },
          cache: 'no-cache'
        })
        .then(response => {
          clearTimeout(timeoutId); // Clear the timeout
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          console.log('Response received, parsing JSON...');
          return response.json();
        })
        .then(data => {
          console.log('JSON parsed successfully');
          resolve(data);
        })
        .catch(error => {
          clearTimeout(timeoutId); // Clear the timeout
          console.error(`Failed to fetch from ${urls[index]}:`, error);
          // Try the next URL
          fetchWithFallback(urls, index + 1)
            .then(resolve)
            .catch(reject);
        });
      });
    }
      
    // Process the data once we have it
    function processData(data) {
      console.log('Processing data:', data ? (Array.isArray(data) ? data.length + ' items' : 'object') : 'null');
      
      // Clear the global timeout since we got data
      clearTimeout(globalTimeoutId);
      
      // If data is in unexpected format, transform it
      if (data && typeof data === 'object' && !Array.isArray(data)) {
        console.log('Converting object to array');
        // Handle case where data is an object instead of array
        if (data.facilities && Array.isArray(data.facilities)) {
          data = data.facilities;
        } else {
          // Try to extract array if data is wrapped in another property
          for (const key in data) {
            if (Array.isArray(data[key])) {
              console.log(`Found array in property ${key}`);
              data = data[key];
              break;
            }
          }
        }
      }
      
      // Fallback if data is empty or not an array
      if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn('Invalid or empty data, using sample data');
        data = generateSampleData();
      }
      
      rawData = data;
      
      // Enrich with VIP data
      enrichWithVIPData(rawData);
      
      // Try the GeoJSON approach first
      try {
        // Convert to GeoJSON
        const geojsonData = {
          type: 'FeatureCollection',
          features: rawData.map(item => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
            },
            properties: { ...item }
          }))
        };
        
        // Check if the source already exists
        if (map.getSource('facilities')) {
          console.log('Updating existing source data');
          map.getSource('facilities').setData(geojsonData);
        } else {
          // Add the source
          console.log('Adding new facilities source');
          map.addSource('facilities', {
            type: 'geojson',
            data: geojsonData,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 50,
            clusterProperties: {
              // Count sites by type
              hyderabad_count: ['+', ['case', ['==', ['get', 'type'], 'hyderabad-police'], 1, 0]],
              cyberabad_count: ['+', ['case', ['==', ['get', 'type'], 'cyberabad-police'], 1, 0]],
              // Count sites by tier
              vip_count: ['+', ['case', ['==', ['get', 'tier'], 'vip'], 1, 0]],
              platinum_count: ['+', ['case', ['==', ['get', 'tier'], 'platinum'], 1, 0]],
              gold_count: ['+', ['case', ['==', ['get', 'tier'], 'gold'], 1, 0]],
              silver_count: ['+', ['case', ['==', ['get', 'tier'], 'silver'], 1, 0]]
            }
          });
        }
        
        // Add the layers
        addMapLayers();
        
        // Setup map interactions
        setupMapInteraction();
        
        // Fit map to the points
        fitBoundsToSource('facilities');
      } catch (error) {
        console.error('Error setting up map source/layers:', error);
        console.log('Falling back to direct marker creation');
        createDirectMarkers(rawData);
      }
      
      // Update stats and hide loader
      updateStats(rawData);
      loader.style.display = 'none';
      
      // Show success message
      showStatus(`Data loaded successfully (${rawData.length} facilities)`, 'success');
    }
    
    // Directly create markers without relying on GeoJSON - most reliable approach
    function createDirectMarkers(data) {
      console.log('Creating direct markers for', data.length, 'facilities');
      
      // Remove any existing markers
      markers.forEach(marker => {
        try {
          marker.remove();
        } catch (e) {
          console.warn('Error removing marker:', e);
        }
      });
      
      markers = [];
      visibleMarkers = [];
      
      // Create a marker for each facility
      data.forEach((item, index) => {
        try {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          
          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`Invalid coordinates for ${item.siteName}: ${item.latitude}, ${item.longitude}`);
            return;
          }
          
          // Create marker element
          const el = document.createElement('div');
          el.className = `custom-marker ${item.type || 'unknown'} ${item.tier || 'unknown'}`;
          el.innerHTML = item.type === 'hyderabad-police' ? 'H' : 'C';
          el.style.zIndex = '999'; // Ensure high z-index
          
          // Create and add the marker
          const marker = new mapboxgl.Marker({
            element: el,
            anchor: 'center'
          })
            .setLngLat([lng, lat])
            .addTo(map);
          
          // Add click handler
          marker.getElement().addEventListener('click', () => {
            if (currentPopup) currentPopup.remove();
            
            // Create popup HTML
            const popupContent = createFacilityPopupHTML(item);
            
            // Show popup
            currentPopup = new mapboxgl.Popup({
              offset: 25,
              closeButton: true,
              closeOnClick: true,
              maxWidth: '350px'
            })
              .setLngLat([lng, lat])
              .setHTML(popupContent)
              .addTo(map);
          });
          
          // Store marker references
          markers.push(marker);
          visibleMarkers.push(marker);
        } catch (e) {
          console.error(`Error creating marker for ${item.siteName || 'Unknown'}:`, e);
        }
      });
      
      console.log(`Successfully created ${markers.length} markers`);
      
      // If we have markers, fit the map to them
      if (markers.length > 0) {
        const bounds = new mapboxgl.LngLatBounds();
        
        data.forEach(item => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          if (!isNaN(lat) && !isNaN(lng)) {
            bounds.extend([lng, lat]);
          }
        });
        
        if (!bounds.isEmpty()) {
          console.log('Fitting map to bounds');
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 350, right: 50 },
            maxZoom: 13,
            duration: 1000
          });
        }
      }
      
      return markers.length > 0;
    }
    
    // Fixed: fetchDataAndBuildLayers function with proper Promise handling
    function fetchDataAndBuildLayers() {
      showStatus('Loading facility data...', 'loading');
      console.log('Fetching facility data...');
      
      // URLs to try in sequence
      const urls = [
        'https://raw.githubusercontent.com/Vibraneum/facilty-data/main/facilities.json',
        // Add alternate URLs here as fallbacks
        './facilities.json' // Local file - include this if you've saved it locally
      ];
      
      // Try fetching from the first URL, then fall back to others if needed
      fetchWithFallback(urls)
        .then(data => {
          console.log('Data loaded successfully:', typeof data, Array.isArray(data) ? data.length + ' items' : 'object');
          
          // If data is in unexpected format, transform it
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            console.log('Converting object to array');
            // Handle case where data is an object instead of array
            if (data.facilities && Array.isArray(data.facilities)) {
              return data.facilities;
            }
            // Try to extract array if data is wrapped in another property
            for (const key in data) {
              if (Array.isArray(data[key])) {
                console.log(`Found array in property ${key}`);
                return data[key];
              }
            }
          }
          return data;
        })
        .then(processData)
        .catch(error => {
          console.error('All fetch attempts failed:', error);
          // Use sample data as last resort
          processData(generateSampleData());
        });
    }

    // Fixed: Properly defined enrichWithVIPData function
    function enrichWithVIPData(data) {
      if (!data || !Array.isArray(data)) {
        console.warn('Invalid data provided to enrichWithVIPData');
        return;
      }
      
      data.forEach(site => {
        // Skip if not a VIP tier or already has data
        if (site.tier !== 'vip') return;
        
        // Get site name without suffixes for matching
        let baseName = site.siteName || '';
        baseName = baseName.replace(/\s*(PS|Police Station)\s*$/i, '').trim();
        
        // Try to match with sampleVIPData
        let matched = false;
        for (const key in sampleVIPData) {
          if (baseName.includes(key) || key.includes(baseName)) {
            Object.assign(site, sampleVIPData[key]);
            matched = true;
            break;
          }
        }
        
        // If no match, generate random data
        if (!matched) {
          site.staff = site.staff || Math.floor(Math.random() * 30) + 20;
          site.chemicals = site.chemicals || Math.floor(Math.random() * 10) + 5;
          site.wasteVehicles = site.wasteVehicles || Math.floor(Math.random() * 4) + 1;
          site.machines = site.machines || Math.floor(Math.random() * 10) + 5;
        }
      });
    }

    // Fixed: addMapLayers function with direct hex colors
    function addMapLayers() {
      // Check if source exists
      if (!map.getSource('facilities')) {
        console.error('Source "facilities" does not exist');
        return;
      }
      
      // Remove existing layers if they exist
      const layersToRemove = ['clusters', 'cluster-count', 'unclustered-point', 'unclustered-label', 'tier-indicator'];
      layersToRemove.forEach(layer => {
        if (map.getLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      
      // Add a layer for the clusters
      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'facilities',
        filter: ['has', 'point_count'],
        paint: {
          // Size circles based on cluster size
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,   // Default radius of 20px
            5,    // If point_count >= 5
            25,   // radius = 25px
            10,   // If point_count >= 10
            30,   // radius = 30px
            20,   // If point_count >= 20
            35    // radius = 35px
          ],
          // Color circles based on cluster composition - USING DIRECT HEX COLORS
          'circle-color': [
            'case',
            ['>', ['get', 'hyderabad_count'], ['get', 'cyberabad_count']], 
            '#3366cc',  // More Hyderabad police - direct color
            '#0099c6'   // More or equal Cyberabad police - direct color
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add a layer for cluster counts
      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'facilities',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-size': 14,
          'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold']
        },
        paint: {
          'text-color': '#ffffff'
        }
      });
      
      // Create a layer for individual points - USING DIRECT HEX COLORS
      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-radius': 12,
          'circle-color': [
            'match',
            ['get', 'type'],
            'hyderabad-police', '#3366cc',  // Direct color
            'cyberabad-police', '#0099c6',  // Direct color
            '#cccccc'  // fallback color
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add a symbol layer for individual points
      map.addLayer({
        id: 'unclustered-label',
        type: 'symbol',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'text-field': [
            'match',
            ['get', 'type'],
            'hyderabad-police', 'H',
            'cyberabad-police', 'C',
            'X'
          ],
          'text-size': 10,
          'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold']
        },
        paint: {
          'text-color': '#ffffff'
        }
      });
      
      // Add a second ring to show tier color - USING DIRECT HEX COLORS
      map.addLayer({
        id: 'tier-indicator',
        type: 'circle',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-radius': 6,
          'circle-color': [
            'match',
            ['get', 'tier'],
            'vip', '#ff4500',       // Direct color
            'platinum', '#e5e4e2',  // Direct color
            'gold', '#ffd700',      // Direct color
            'silver', '#c0c0c0',    // Direct color
            '#cccccc'  // fallback color
          ],
          'circle-stroke-width': 1,
          'circle-stroke-color': '#ffffff',
          'circle-translate': [10, -10]
        }
      });
      
      console.log('Map layers added successfully');
    }

    function setupMapInteraction() {
      // Click handler for clusters
      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        if (!features || features.length === 0) return;
        
        const clusterId = features[0].properties.cluster_id;
        
        // Get cluster expansion info
        map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          
          // Get cluster center
          const coordinates = features[0].geometry.coordinates.slice();
          
          // Create cluster popup content
          const hyderabadCount = features[0].properties.hyderabad_count || 0;
          const cyberabadCount = features[0].properties.cyberabad_count || 0;
          const vipCount = features[0].properties.vip_count || 0;
          const platinumCount = features[0].properties.platinum_count || 0;
          const goldCount = features[0].properties.gold_count || 0;
          const silverCount = features[0].properties.silver_count || 0;
          
          const popupContent = `
            <div class="custom-popup">
              <h3>Cluster Details</h3>
              <div class="popup-stats-grid">
                ${buildStatCard('fa-shield-alt', hyderabadCount, 'Hyderabad')}
                ${buildStatCard('fa-laptop-code', cyberabadCount, 'Cyberabad')}
                ${buildStatCard('fa-crown', vipCount, 'VIP')}
                ${buildStatCard('fa-medal', platinumCount, 'Platinum')}
                ${buildStatCard('fa-award', goldCount, 'Gold')}
                ${buildStatCard('fa-certificate', silverCount, 'Silver')}
              </div>
              <div style="text-align: center; margin-top: 10px;">
                <button id="zoom-to-cluster" style="background-color: #007bff; color: white; 
                       border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                  <i class="fas fa-search-plus"></i> Zoom In
                </button>
              </div>
            </div>
          `;
          
          // Create and show popup
          if (currentPopup) currentPopup.remove();
          
          currentPopup = new mapboxgl.Popup({
            offset: 25,
            closeButton: true,
            closeOnClick: false,
            maxWidth: '350px'
          })
            .setLngLat(coordinates)
            .setHTML(popupContent)
            .addTo(map);
          
          // Add zoom button click handler
          setTimeout(() => {
            const zoomButton = document.getElementById('zoom-to-cluster');
            if (zoomButton) {
              zoomButton.addEventListener('click', () => {
                currentPopup.remove();
                map.flyTo({
                  center: coordinates,
                  zoom: zoom + 1,
                  duration: 1000
                });
              });
            }
          }, 100);
        });
      });
      
      // Hover effects for clusters
      map.on('mouseenter', 'clusters', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'clusters', () => {
        map.getCanvas().style.cursor = '';
      });
      
      // Click handler for individual points
      map.on('click', 'unclustered-point', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['unclustered-point'] });
        if (!features || features.length === 0) return;
        
        const properties = features[0].properties;
        const coordinates = features[0].geometry.coordinates.slice();
        
        // Format popup content based on site data
        const popupContent = createFacilityPopupHTML(properties);
        
        // Create popup
        if (currentPopup) currentPopup.remove();
        
        currentPopup = new mapboxgl.Popup({
          offset: 25,
          closeButton: true,
          closeOnClick: true,
          maxWidth: '350px'
        })
          .setLngLat(coordinates)
          .setHTML(popupContent)
          .addTo(map);
      });
      
      // Hover effects for points
      map.on('mouseenter', 'unclustered-point', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'unclustered-point', () => {
        map.getCanvas().style.cursor = '';
      });
    }

    // Create HTML for facility popup
    function createFacilityPopupHTML(properties) {
      // Parse string properties - JSON properties get stringified when in GeoJSON layers
      let props = properties;
      
      // If properties come from GeoJSON, they might be stringified
      if (typeof properties === 'string') {
        try {
          props = JSON.parse(properties);
        } catch (e) {
          console.error('Error parsing properties:', e);
        }
      }
      
      const squareFeet = parseInt(props.squareFeet) || 0;
      const staff = parseInt(props.staff) || 0;
      const chemicals = parseInt(props.chemicals) || 0;
      const wasteVehicles = parseInt(props.wasteVehicles) || 0;
      const machines = parseInt(props.machines) || 0;
      
      // Format facility name
      const siteName = props.siteName || 'Unknown Site';
      const siteType = props.type || 'unknown';
      const siteTier = props.tier || 'unknown';
      
      // Start building popup HTML
      let html = `<div class="custom-popup">`;
      
      // Header with site type icon and tier badge
      html += `
      <div class="popup-header-info">
        <span class="site-type-icon ${
          siteType === 'hyderabad-police' ? 'type-hyderabad-police' :
          siteType === 'cyberabad-police' ? 'type-cyberabad-police' : ''
        }">
          // from here buddy
          ${siteType === 'hyderabad-police' ? '<i class="fas fa-shield-alt"></i>' :
            siteType === 'cyberabad-police' ? '<i class="fas fa-laptop-code"></i>' :
            '<i class="fas fa-map-marker-alt"></i>'}
        </span>
        <h3>${siteName}</h3>
        <span class="popup-tier-badge ${siteTier}">
          ${siteTier === 'vip' ? '<i class="fas fa-crown"></i> VIP' :
            siteTier === 'platinum' ? '<i class="fas fa-medal"></i> Platinum' :
            siteTier === 'gold' ? '<i class="fas fa-award"></i> Gold' :
            '<i class="fas fa-certificate"></i> Silver'}
        </span>
      </div>`;

      // VIP sites get detailed statistics
      if (siteTier === 'vip') {
        html += `<div class="popup-stats-grid">`;
        // Core information
        html += buildStatCard('fa-chart-area', formatNumber(squareFeet) + ' sq ft', 'Area');
        
        // VIP-specific information
        if (staff) html += buildStatCard('fa-user', staff, 'Staff');
        if (chemicals) html += buildStatCard('fa-flask', chemicals, 'Chemicals');
        if (wasteVehicles) html += buildStatCard('fa-truck', wasteVehicles, 'Waste Veh');
        if (machines) html += buildStatCard('fa-cogs', machines, 'Machines');
        html += `</div>`;
      } else {
        // Non-VIP layout
        html += `<p><strong>Square Feet:</strong> ${formatNumber(squareFeet)} sq ft</p>`;
      }
      
      // Add address for all sites
      if (props.address) {
        html += `<div class="popup-address"><i class="fas fa-map-marker-alt"></i> ${props.address}</div>`;
      }

      html += `</div>`;
      
      return html;
    }

    // Build HTML for a stat card
    function buildStatCard(iconClass, value, label) {
      return `
        <div class="popup-stat-card">
          <div class="popup-stat-icon"><i class="fas ${iconClass}"></i></div>
          <div class="popup-stat-value">${value}</div>
          <div class="popup-stat-label">${label}</div>
        </div>
      `;
    }

    // Helper function to format numbers with commas
    function formatNumber(num) {
      if (!num) return 'N/A';
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Generate sample data if fetch fails
    function generateSampleData() {
      console.log('Generating sample data');
      return EMERGENCY_DATA;
    }

    // Helper function to fit map bounds to a source
    function fitBoundsToSource(sourceName) {
      try {
        const sourceFeatures = map.querySourceFeatures(sourceName);
        
        if (sourceFeatures.length === 0) {
          // Fallback to Hyderabad center if no features
          map.flyTo({
            center: [78.4867, 17.3850],
            zoom: 11
          });
          return;
        }
        
        const bounds = new mapboxgl.LngLatBounds();
        
        sourceFeatures.forEach(feature => {
          if (feature.geometry && feature.geometry.type === 'Point') {
            bounds.extend(feature.geometry.coordinates);
          }
        });
        
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 350, right: 50 },
            maxZoom: 14,
            duration: 1000
          });
        }
      } catch (error) {
        console.error('Error fitting bounds:', error);
        // Fallback to Hyderabad center
        map.flyTo({
          center: [78.4867, 17.3850],
          zoom: 11
        });
      }
    }

    // Update statistics in sidebar
    function updateStats(data) {
      if (!data || !Array.isArray(data)) {
        statsContainer.innerHTML = '<p>No statistics available</p>';
        return;
      }
      
      // Count by type
      const typeCount = {
        'hyderabad-police': 0,
        'cyberabad-police': 0
      };
      
      // Count by tier
      const tierCount = {
        'vip': 0,
        'platinum': 0,
        'gold': 0,
        'silver': 0
      };
      
      // Calculate stats
      data.forEach(item => {
        if (item.type) typeCount[item.type] = (typeCount[item.type] || 0) + 1;
        if (item.tier) tierCount[item.tier] = (tierCount[item.tier] || 0) + 1;
      });
      
      // Generate HTML
      let html = `
        <div style="font-size: 14px; line-height: 1.6;">
          <p><strong>Total Facilities:</strong> ${data.length}</p>
          <p><strong>Types:</strong> 
            Hyderabad (${typeCount['hyderabad-police'] || 0}), 
            Cyberabad (${typeCount['cyberabad-police'] || 0})
          </p>
          <p><strong>Categories:</strong><br>
            <span style="color: #ff4500;"><i class="fas fa-crown"></i> VIP:</span> ${tierCount['vip'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-medal"></i> Platinum:</span> ${tierCount['platinum'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-award"></i> Gold:</span> ${tierCount['gold'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-certificate"></i> Silver:</span> ${tierCount['silver'] || 0}
          </p>
        </div>
      `;
      
      statsContainer.innerHTML = html;
    }

    // Show status message
    function showStatus(message, type = 'info') {
      statusText.textContent = message;
      statusIndicator.className = 'status-indicator';
      
      if (type === 'error') {
        statusIndicator.classList.add('error');
        statusIndicator.querySelector('i').className = 'fas fa-exclamation-circle';
      } else if (type === 'loading') {
        statusIndicator.querySelector('i').className = 'fas fa-spinner fa-spin';
      } else {
        statusIndicator.querySelector('i').className = 'fas fa-check-circle';
      }
      
      statusIndicator.classList.add('visible');
      
      // Hide after 5 seconds unless it's a loading message
      if (type !== 'loading') {
        setTimeout(() => {
          statusIndicator.classList.remove('visible');
        }, 5000);
      }
    }

    // Fixed: Create a robust fetchFacilityData function for the "RELOAD ALL DATA" button
    function fetchFacilityData() {
      console.log('Loading full dataset...');
      
      // Show loading status
      showStatus('Loading all facilities...', 'loading');
      
      // URLs to try in sequence
      const urls = [
        'https://raw.githubusercontent.com/Vibraneum/facilty-data/main/facilities.json',
        './facilities.json' // Local file
      ];
      
      // Try fetching with proper Promise handling
      fetchWithFallback(urls)
        .then(data => {
          console.log('Facility data loaded successfully:', data.length, 'items');
          processData(data);
          return true;
        })
        .catch(error => {
          console.error('Error loading facility data:', error);
          
          // If we have previous data, reuse it instead of emergency data
          if (rawData && rawData.length > 0) {
            console.log('Reusing existing data');
            processData(rawData);
          } else {
            // Use emergency data as last resort
            console.log('Using emergency data');
            processData(generateSampleData());
          }
          
          showStatus(`Failed to load data: ${error.message}. Using previous/emergency data.`, 'error');
          return false;
        });
    }

    // Sample data button now loads the full dataset
    document.getElementById('load-sample-data').addEventListener('click', () => {
      fetchFacilityData();
    });
    
    // Sidebar toggle functionality
    sidebarTgl.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const icon = sidebarTgl.querySelector('i');
      if (sidebar.classList.contains('collapsed')) {
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      } else {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      }
    });

    // Filter functionality
    function applyFilters() {
      const activeTypes = [];
      const activeTiers = [];
      
      // Get selected filter values
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      // Try using MapBox filters first
      try {
        if (map.getLayer('unclustered-point')) {
          // Build filter expressions
          const typeFilter = ['any', ...activeTypes.map(type => ['==', ['get', 'type'], type])];
          const tierFilter = ['any', ...activeTiers.map(tier => ['==', ['get', 'tier'], tier])];
          
          // Apply filter to unclustered points
          map.setFilter('unclustered-point', ['all', ['!', ['has', 'point_count']], typeFilter, tierFilter]);
          map.setFilter('unclustered-label', ['all', ['!', ['has', 'point_count']], typeFilter, tierFilter]);
          map.setFilter('tier-indicator', ['all', ['!', ['has', 'point_count']], typeFilter, tierFilter]);
          
          console.log('Applied MapBox filters for types:', activeTypes, 'and tiers:', activeTiers);
        }
      } catch (e) {
        console.error('Error applying MapBox filters:', e);
      }
      
      // Also apply direct filtering to markers as fallback
      markers.forEach((marker, index) => {
        if (!rawData || index >= rawData.length) return;
        
        const item = rawData[index];
        const typeMatch = activeTypes.includes(item.type);
        const tierMatch = activeTiers.includes(item.tier);
        
        if (typeMatch && tierMatch) {
          marker.getElement().style.display = 'block';
          if (!visibleMarkers.includes(marker)) {
            visibleMarkers.push(marker);
          }
        } else {
          marker.getElement().style.display = 'none';
          const idx = visibleMarkers.indexOf(marker);
          if (idx !== -1) {
            visibleMarkers.splice(idx, 1);
          }
        }
      });
      
      showStatus(`Showing ${visibleMarkers.length} of ${markers.length} facilities`, 'info');
    }

    // Filter checkboxes
    const checkboxes = document.querySelectorAll('.checkbox-container input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        applyFilters();
      });
    });

    // Search functionality
    searchBar.addEventListener('input', () => {
      const query = searchBar.value.trim().toLowerCase();
      
      // Reset if empty query
      if (query === '') {
        // Make all markers visible (subject to filters)
        applyFilters();
        return;
      }
      
      // Get active filters
      const activeTypes = [];
      const activeTiers = [];
      
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      // Clear visible markers array
      visibleMarkers = [];
      
      // Filter markers directly
      markers.forEach((marker, index) => {
        if (!rawData || index >= rawData.length) return;
        
        const item = rawData[index];
        const nameMatch = item.siteName && item.siteName.toLowerCase().includes(query);
        const addressMatch = item.address && item.address.toLowerCase().includes(query);
        const typeMatch = activeTypes.includes(item.type);
        const tierMatch = activeTiers.includes(item.tier);
        
        if ((nameMatch || addressMatch) && typeMatch && tierMatch) {
          marker.getElement().style.display = 'block';
          visibleMarkers.push(marker);
        } else {
          marker.getElement().style.display = 'none';
        }
      });
      
      // Update status
      showStatus(`Found ${visibleMarkers.length} matches`, 'info');
      
      // If single result, zoom to it
      if (visibleMarkers.length === 1) {
        const markerIndex = markers.indexOf(visibleMarkers[0]);
        if (markerIndex !== -1 && rawData && markerIndex < rawData.length) {
          const item = rawData[markerIndex];
          map.flyTo({
            center: [parseFloat(item.longitude), parseFloat(item.latitude)],
            zoom: 15,
            duration: 1000
          });
        }
      } 
      // If multiple results but not too many, fit bounds
      else if (visibleMarkers.length > 1 && visibleMarkers.length < 50) {
        const bounds = new mapboxgl.LngLatBounds();
        
        visibleMarkers.forEach(marker => {
          bounds.extend(marker.getLngLat());
        });
        
        map.fitBounds(bounds, {
          padding: { top: 100, bottom: 100, left: 350, right: 50 },
          maxZoom: 14,
          duration: 1000
        });
      }
    });

    // Map style radio buttons
    const layerIds = ['streets-v11', 'light-v10', 'dark-v10', 'satellite-v9'];
    layerIds.forEach(layerId => {
      document.getElementById(layerId).addEventListener('change', function() {
        map.setStyle('mapbox://styles/mapbox/' + layerId);
      });
    });
  </script>
</body>
</html>
