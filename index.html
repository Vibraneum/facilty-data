<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ixora Facility Management - Police Stations Hyderabad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MAPBOX GL JS - Updated to specific working version -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --primary-color: #0056b3;
      --primary-light: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --body-bg: #f8f9fa;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition-speed: 0.3s;
      --primary-light-rgb: 0, 123, 255;

      /* Category colors */
      --vip-color: #ff4500;
      --platinum-color: #e5e4e2;
      --gold-color: #ffd700;
      --silver-color: #c0c0c0;

      /* Site type colors */
      --hyderabad-color: #3366cc;
      --cyberabad-color: #0099c6;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--body-bg);
      color: var(--dark-color);
    }

    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .header {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
      padding: 15px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      max-width: 90%;
      text-align: center;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header img {
      height: 40px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .sidebar {
      position: absolute;
      top: 80px;
      left: 20px;
      bottom: 20px;
      width: 300px;
      z-index: 1000;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow-y: auto;
      transition: transform var(--transition-speed), background-color var(--transition-speed);
      transform: translateX(0);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .sidebar-content {
      padding: 20px;
    }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background-color: var(--primary-light);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 10;
      transition: transform 0.2s ease;
    }
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    .sidebar.collapsed {
      transform: translateX(-340px);
    }

    .filter-section {
      margin-bottom: 24px;
    }
    .filter-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      transition: color var(--transition-speed);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-section h3 i {
      color: var(--primary-light);
    }
    .checkbox-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.2s ease;
    }
    .checkbox-item:hover {
      transform: translateX(5px);
    }
    .custom-checkbox {
      position: relative;
      display: flex;
      align-items: center;
    }
    .custom-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    .checkmark {
      height: 20px;
      width: 20px;
      background-color: #eee;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .custom-checkbox:hover input ~ .checkmark {
      background-color: #ccc;
    }
    .custom-checkbox input:checked ~ .checkmark {
      background-color: var(--primary-light);
    }
    .checkmark:after {
      content: "\f00c";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      display: none;
      font-size: 12px;
    }
    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #search-bar {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      background-color: var(--light-color);
      color: var(--dark-color);
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    #search-bar:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(var(--primary-light-rgb), 0.25);
    }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary-color);
    }

    /* Legend styles - improved positioning and interaction */
    .legend {
      position: absolute;
      bottom: 90px;
      right: 20px;
      z-index: 900;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .legend h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
    }

    /* Add legend minimize button */
    .legend-minimize {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s ease;
    }

    .legend-minimize:hover {
      background-color: var(--primary-light);
      color: white;
    }

    .legend.minimized {
      transform: translateY(calc(100% - 40px));
      height: 40px;
      max-height: 40px;
      overflow: hidden;
    }

    .legend.minimized h3 {
      margin: 0;
      padding: 0;
      border: none;
    }

    .legend.minimized .legend-section {
      display: none;
    }

    /* Your existing legend styles - preserved */
    .legend-section {
      margin-bottom: 15px;
    }

    .legend-item, .legend-tier-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      transition: transform 0.2s ease;
    }

    .legend-item:hover, .legend-tier-item:hover {
      transform: translateX(5px);
    }

    .legend-color, .legend-tier-icon {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      flex-shrink: 0;
      transition: transform 0.2s ease;
      border: 2px solid white;
    }

    .legend-color:hover, .legend-tier-icon:hover {
      transform: scale(1.1);
    }

    .type-hyderabad-police { background-color: var(--hyderabad-color); }
    .type-cyberabad-police { background-color: var(--cyberabad-color); }
    .tier-vip { background: linear-gradient(135deg, var(--vip-color), #ff6347); color: white; }
    .tier-platinum { background: linear-gradient(135deg, var(--platinum-color), #ffffff); color: #333; }
    .tier-gold { background: linear-gradient(135deg, var(--gold-color), #FFF7CC); color: #333; }
    .tier-silver { background: linear-gradient(135deg, var(--silver-color), #E6E6E6); color: #333; }

    /* Improve map controls positioning to avoid overlap with legend */
    .mapboxgl-ctrl-top-right {
      top: 20px !important;
      right: 20px !important;
    }

    .mapboxgl-ctrl-bottom-right {
      bottom: 20px !important;
      right: 20px !important;
    }
    /* VIP Popup styling */
    .custom-popup {
      max-width: 350px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      color: var(--dark-color);
    }
    .custom-popup h3 {
      margin: 0 0 12px 0;
      color: var(--dark-color);
      font-size: 18px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .site-type-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      margin-right: 10px;
      flex-shrink: 0;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .popup-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .popup-stat-card {
      background-color: rgba(var(--primary-light-rgb), 0.1);
      border-radius: var(--border-radius);
      padding: 12px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(var(--primary-light-rgb), 0.2);
    }
    .popup-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .popup-stat-icon {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--primary-light);
    }
    .popup-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--dark-color);
    }
    .popup-stat-label {
      font-size: 12px;
      color: var(--secondary-color);
      margin-top: 3px;
    }
    
    .popup-header-info {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .popup-tier-badge {
      background-color: var(--light-color);
      border-radius: 20px;
      padding: 3px 8px;
      font-size: 12px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }
    
    .popup-tier-badge.vip {
      background-color: var(--vip-color);
      color: white;
    }
    
    .popup-tier-badge.platinum {
      background-color: var(--platinum-color);
      color: #333;
    }
    
    .popup-tier-badge.gold {
      background-color: var(--gold-color);
      color: #333;
    }
    
    .popup-tier-badge.silver {
      background-color: var(--silver-color);
      color: #333;
    }

    .popup-address {
      background-color: rgba(var(--primary-light-rgb), 0.05);
      padding: 12px;
      border-radius: var(--border-radius);
      margin-top: 10px;
      font-size: 14px;
      border-left: 3px solid var(--primary-light);
    }
    
    .popup-address i {
      color: var(--primary-light);
      margin-right: 5px;
    }

    .loader-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-light);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 500;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Custom Mapbox marker styles - Enhanced visibility */
    .mapboxgl-marker {
      transition: transform 0.3s ease;
      z-index: 100 !important; /* Ensure markers are above other map elements */
    }
    .mapboxgl-marker:hover {
      transform: scale(1.2);
      z-index: 200 !important;
    }
    
    .custom-marker {
      width: 36px; /* Larger size */
      height: 36px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 16px; /* Larger text */
      box-shadow: 0 3px 8px rgba(0,0,0,0.5); /* More pronounced shadow */
      border: 3px solid white; /* Thicker border */
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .custom-marker:hover {
      transform: scale(1.2);
      box-shadow: 0 5px 15px rgba(0,0,0,0.7);
    }
    
    .custom-marker.hyderabad-police {
      background-color: #3366cc;
    }
    
    .custom-marker.cyberabad-police {
      background-color: #0099c6;
    }
    
    /* Category indicators with enhanced visibility */
    .custom-marker.vip::after,
    .custom-marker.platinum::after,
    .custom-marker.gold::after,
    .custom-marker.silver::after {
      content: "";
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px; /* Larger indicator */
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    
    .custom-marker.vip::after {
      background-color: #ff4500;
    }
    
    .custom-marker.platinum::after {
      background-color: #e5e4e2;
    }
    
    .custom-marker.gold::after {
      background-color: #ffd700;
    }
    
    .custom-marker.silver::after {
      background-color: #c0c0c0;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .status-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .status-indicator i {
      color: var(--success-color);
    }
    
    .status-indicator.error i {
      color: var(--danger-color);
    }

    /* Responsive & smaller screens */
    @media (max-width: 768px) {
      .header {
        width: calc(100% - 40px);
        padding: 10px 15px;
      }
      .sidebar {
        width: 250px;
      }
      .legend {
        bottom: 10px;
        right: 10px;
        width: 200px;
      }
    }
    @media (max-width: 576px) {
      .header h1 {
        font-size: 16px;
      }
      .header img {
        height: 30px;
      }
      .sidebar.collapsed {
        transform: translateX(-240px);
      }
    }
  </style>
</head>

<body>
  <div id="map-container">
    <!-- Loader -->
    <div class="loader-container" id="loader">
      <div class="loader"></div>
      <div class="loader-text">Loading facility data...</div>
    </div>

    <!-- Header -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/Vibraneum/facilty-data/refs/heads/main/Ixora%20FM%20logo.png" alt="Ixora FM Logo">
      <h1>Ixora Facility Management - Police Stations Hyderabad</h1>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </div>
      <div class="sidebar-content">
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="Search by site name...">
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-filter"></i> Site Types</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="hyderabad-police" checked data-type="hyderabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Hyderabad Police</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="cyberabad-police" checked data-type="cyberabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Cyberabad Police</span>
            </div>
          </div>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-medal"></i> Site Category</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="vip-tier" checked data-tier="vip"/>
                <span class="checkmark"></span>
              </label>
              <span>VIP</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="platinum-tier" checked data-tier="platinum"/>
                <span class="checkmark"></span>
              </label>
              <span>Platinum</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="gold-tier" checked data-tier="gold"/>
                <span class="checkmark"></span>
              </label>
              <span>Gold</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="silver-tier" checked data-tier="silver"/>
                <span class="checkmark"></span>
              </label>
              <span>Silver</span>
            </div>
          </div>
        </div>
        
        <div class="filter-section">
          <h3><i class="fas fa-info-circle"></i> Statistics</h3>
          <div id="stats-container">
            Loading statistics...
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend" id="legend">
      <div class="legend-section">
        <h3>Site Types</h3>
        <div class="legend-item">
          <div class="legend-color type-hyderabad-police">
            <i class="fas fa-shield-alt"></i>
          </div>
          <span>Hyderabad Police</span>
        </div>
        <div class="legend-item">
          <div class="legend-color type-cyberabad-police">
            <i class="fas fa-laptop-code"></i>
          </div>
          <span>Cyberabad Police</span>
        </div>
      </div>
      <!-- Fallback button for manual data loading -->
      <div class="legend-section" style="margin: 20px 0; text-align: center;">
        <button id="load-sample-data" style="background-color: #ff6b00; color: white; 
               border: none; padding: 12px 15px; border-radius: 4px; cursor: pointer;
               width: 100%; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
               font-size: 14px; display: flex; align-items: center; justify-content: center;
               gap: 8px;">
          <i class="fas fa-database" style="font-size: 18px;"></i> 
          <span>LOAD SAMPLE DATA</span>
        </button>
        <div style="font-size: 12px; margin-top: 5px; color: #555;">
          Click this if no markers appear
        </div>
      </div>
      
      <div class="legend-section">
        <h3>Site Categories</h3>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-vip">V</div>
          <span>VIP Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-platinum">P</div>
          <span>Platinum Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-gold">G</div>
          <span>Gold Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-silver">S</div>
          <span>Silver Tier</span>
        </div>
      </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="status-indicator" id="status-indicator">
      <i class="fas fa-check-circle"></i>
      <span id="status-text">Data loaded successfully</span>
    </div>

    <div id="map"></div>
  </div>

  <script>
    // Use your actual Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoidmVkYW50aG5hdGgiLCJhIjoiY203c3lsOWZyMGs4MzJpcmJoZTY1Ync4bSJ9.Hx83V0-qM8JOmh4y_SSXCw';

    // Create the map with improved style and style controls
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11', // Changed to streets style for better visibility
      center: [78.4867, 17.3850], // Hyderabad center
      zoom: 11,
      pitch: 15, // Slight pitch for better 3D look
      bearing: 0
    });
    
    // Add style control
    const layerList = document.getElementById('map-styles');
    const inputs = layerList.getElementsByTagName('input');
    
    for (const input of inputs) {
      input.onclick = (layer) => {
        const layerId = layer.target.id;
        map.setStyle('mapbox://styles/mapbox/' + layerId);
      };
    }

    // UI Elements
    const loader = document.getElementById('loader');
    const sidebar = document.getElementById('sidebar');
    const sidebarTgl = document.getElementById('sidebar-toggle');
    const searchBar = document.getElementById('search-bar');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const statsContainer = document.getElementById('stats-container');

    let rawData = null;        // store fetched JSON
    let currentPopup = null;   // track open popup
    let markers = [];          // store all markers
    let visibleMarkers = [];   // track which markers are visible
    
    // Sample VIP data to ensure proper display
    const sampleVIPData = {
      "Saifabad": { staff: 45, supervisors: 5, managers: 2, area: "12,500 sq ft", chemicals: 12, wasteVehicles: 4, machines: 15 },
      "Begumpet": { staff: 38, supervisors: 4, managers: 1, area: "10,200 sq ft", chemicals: 9, wasteVehicles: 3, machines: 12 },
      "Charminar": { staff: 52, supervisors: 6, managers: 2, area: "15,800 sq ft", chemicals: 15, wasteVehicles: 5, machines: 18 },
      "Jubilee Hills": { staff: 41, supervisors: 5, managers: 2, area: "11,600 sq ft", chemicals: 11, wasteVehicles: 4, machines: 14 },
      "Gachibowli": { staff: 35, supervisors: 3, managers: 1, area: "9,800 sq ft", chemicals: 8, wasteVehicles: 3, machines: 10 },
      "Kukatpally": { staff: 47, supervisors: 5, managers: 2, area: "13,200 sq ft", chemicals: 13, wasteVehicles: 4, machines: 16 }
    };

    // Make sure mapboxgl is defined
    if (typeof mapboxgl === 'undefined') {
      console.error('Mapbox GL JS is not loaded. Check your internet connection or try a different browser.');
      alert('Mapbox GL JS failed to load. Please check your internet connection and reload the page.');
    }
    
    // Set a global timeout to ensure we show data even if all fetches fail
    const globalTimeoutId = setTimeout(() => {
      console.warn('Global timeout reached, forcing sample data load');
      // If loader is still visible, it means data hasn't loaded yet
      if (loader.style.display !== 'none') {
        document.getElementById('load-sample-data').click();
      }
    }, 10000); // 10 second global timeout

    // Handle potential map initialization errors
    try {
      // Do an immediate load of sample data if needed
      const urlParams = new URLSearchParams(window.location.search);
      const directLoad = urlParams.get('load') === 'sample';
      
      map.on('load', () => {
        console.log('Map has loaded. Setting up...');
        
        // Create a debug status display
        showStatus('Map loaded successfully. Setting up controls...', 'success');
        
        // Add navigation controls with improved positioning
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      
      // Add fullscreen control
      map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
      
      // Add geolocate control
      map.addControl(
        new mapboxgl.GeolocateControl({
          positionOptions: {enableHighAccuracy: true},
          trackUserLocation: true,
          showUserHeading: true
        }), 
        'top-right'
      );
      
      // Check if we should immediately load sample data (for testing)
      if (directLoad) {
        console.log('Direct sample data loading triggered by URL parameter');
        setTimeout(() => {
          document.getElementById('load-sample-data').click();
        }, 1000);
      } else {
        // Fetch data normally
        fetchDataAndBuildLayers();
      }
      });
      
      // Add map style change event handler
      map.on('style.load', () => {
        console.log('Map style loaded/changed');
        
        // If we have markers but changed style, recreate them to ensure visibility
        if (markers.length > 0 && rawData) {
          console.log('Recreating markers after style change');
          setTimeout(() => createDirectMarkers(rawData), 500);
        }
      });
    } catch (error) {
      console.error('Error initializing map:', error);
      alert('Failed to initialize the map. Please try refreshing the page or use the "Load Sample Data" button.');
    }

    // Update your fetchDataAndBuildLayers function to use proper GeoJSON source and layers
    // Function to try multiple URLs in sequence with timeout
    function fetchWithFallback(urls, index) {
      if (index >= urls.length) {
        // If we've tried all URLs, use sample data
        console.error('All URLs failed, using sample data');
        processData(generateSampleData());
        return;
      }
      
      console.log(`Trying URL ${index + 1}/${urls.length}: ${urls[index]}`);
      
      // Add a timeout to prevent hanging
      const timeoutId = setTimeout(() => {
        console.warn(`Fetch timeout for ${urls[index]}`);
        // Skip to next URL or use sample data
        fetchWithFallback(urls, index + 1);
      }, 5000); // 5 second timeout
      
      fetch(urls[index], {
        headers: {
          'Accept': 'application/json'
        },
        // Adding the no-cache option to avoid caching issues
        cache: 'no-cache'
      })
      .then(response => {
        clearTimeout(timeoutId); // Clear the timeout
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        console.log('Response received, parsing JSON...');
        return response.json();
      })
      .then(data => {
        console.log('JSON parsed successfully');
        processData(data);
      })
      .catch(error => {
        clearTimeout(timeoutId); // Clear the timeout
        console.error(`Failed to fetch from ${urls[index]}:`, error);
        // Try the next URL
        fetchWithFallback(urls, index + 1);
      });
    }
    
      // Process the data once we have it
    function processData(data) {
      console.log('Processing data:', data ? (Array.isArray(data) ? data.length + ' items' : 'object') : 'null');
      
      // Clear the global timeout since we got data
      clearTimeout(globalTimeoutId);
      
      // If data is in unexpected format, transform it
      if (data && typeof data === 'object' && !Array.isArray(data)) {
        console.log('Converting object to array');
        // Handle case where data is an object instead of array
        if (data.facilities && Array.isArray(data.facilities)) {
          data = data.facilities;
        } else {
          // Try to extract array if data is wrapped in another property
          for (const key in data) {
            if (Array.isArray(data[key])) {
              console.log(`Found array in property ${key}`);
              data = data[key];
              break;
            }
          }
        }
      }
      
      // Fallback if data is empty or not an array
      if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn('Invalid or empty data, using sample data');
        data = generateSampleData();
      }
      
      rawData = data;
      
      // Enrich with VIP data
      enrichWithVIPData(rawData);
      
      // Convert to GeoJSON
      const geojsonData = {
        type: 'FeatureCollection',
        features: rawData.map(item => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
          },
          properties: { ...item }
        }))
      };
      
      // Add the source and layers
      try {
        // Add the facilities source
        map.addSource('facilities', {
          type: 'geojson',
          data: geojsonData,
          cluster: true,
          clusterMaxZoom: 14,
          clusterRadius: 50,
          clusterProperties: {
            // Count sites by type
            hyderabad_count: ['+', ['case', ['==', ['get', 'type'], 'hyderabad-police'], 1, 0]],
            cyberabad_count: ['+', ['case', ['==', ['get', 'type'], 'cyberabad-police'], 1, 0]],
            // Count sites by tier
            vip_count: ['+', ['case', ['==', ['get', 'tier'], 'vip'], 1, 0]],
            platinum_count: ['+', ['case', ['==', ['get', 'tier'], 'platinum'], 1, 0]],
            gold_count: ['+', ['case', ['==', ['get', 'tier'], 'gold'], 1, 0]],
            silver_count: ['+', ['case', ['==', ['get', 'tier'], 'silver'], 1, 0]]
          }
        });
        
        // Add the layers
        addMapLayers();
        
        // Setup map interactions
        setupMapInteraction();
        
        // Fit map to the points
        fitBoundsToSource('facilities');
      } catch (error) {
        console.error('Error setting up map source/layers:', error);
        createDirectMarkers(rawData);
      }
      
      // Update stats and hide loader
      updateStats(rawData);
      loader.style.display = 'none';
      
      // Show success message
      showStatus(`Data loaded successfully (${rawData.length} facilities)`, 'success');
    }
    
    // Create direct markers - completely rewritten for reliability
    function createDirectMarkers(data) {
      console.log('Creating direct markers for facilities:', data.length);
      showStatus(`Creating ${data.length} markers on map...`, 'loading');
      
      // First, make sure the map is fully loaded
      if (!map.loaded()) {
        console.log('Map not fully loaded, waiting...');
        setTimeout(() => createDirectMarkers(data), 500);
        return;
      }
      
      // Remove any existing markers
      markers.forEach(marker => marker.remove());
      markers = [];
      visibleMarkers = [];
      
      // Wait a moment to ensure map is ready
      setTimeout(() => {
        // Create a marker for each facility
        data.forEach((item, index) => {
          try {
            if (!item.latitude || !item.longitude) {
              console.warn(`Skipping marker for ${item.siteName || 'Unknown'} - missing coordinates`);
              return;
            }
            
            const lat = parseFloat(item.latitude);
            const lng = parseFloat(item.longitude);
            
            if (isNaN(lat) || isNaN(lng)) {
              console.warn(`Invalid coordinates for ${item.siteName}: ${item.latitude}, ${item.longitude}`);
              return;
            }
            
            console.log(`Creating marker ${index+1}/${data.length}: ${item.siteName} at ${lat}, ${lng}`);
            
            // Create marker element
            const el = document.createElement('div');
            el.className = `custom-marker ${item.type || 'unknown'} ${item.tier || 'unknown'}`;
            el.innerHTML = item.type === 'hyderabad-police' ? 'H' : 'C';
            el.setAttribute('title', item.siteName);
            
            // Create the marker with offset to prevent overlap
            const marker = new mapboxgl.Marker({
              element: el,
              anchor: 'center'
            })
              .setLngLat([lng, lat])
              .addTo(map);
            
            // Add click event for popup
            marker.getElement().addEventListener('click', () => {
              if (currentPopup) currentPopup.remove();
              
              // Format popup content
              const popupContent = createFacilityPopupHTML(item);
              
              // Show popup
              currentPopup = new mapboxgl.Popup({
                offset: 25,
                closeButton: true,
                closeOnClick: true,
                maxWidth: '350px'
              })
                .setLngLat([lng, lat])
                .setHTML(popupContent)
                .addTo(map);
            });
            
            // Store marker reference
            markers.push(marker);
            visibleMarkers.push(marker);
          } catch (e) {
            console.error(`Error creating marker for ${item.siteName || 'Unknown'}:`, e);
          }
        });
        
        console.log(`Created ${markers.length} markers successfully`);
        showStatus(`Created ${markers.length} markers successfully`, 'success');
        
        // Fit map to markers if any were created
        if (markers.length > 0) {
          const bounds = new mapboxgl.LngLatBounds();
          data.forEach(item => {
            if (item.latitude && item.longitude) {
              const lat = parseFloat(item.latitude);
              const lng = parseFloat(item.longitude);
              if (!isNaN(lat) && !isNaN(lng)) {
                bounds.extend([lng, lat]);
              }
            }
          });
          
          // Only fit bounds if we have valid coordinates
          if (!bounds.isEmpty()) {
            map.fitBounds(bounds, {
              padding: { top: 100, bottom: 100, left: 350, right: 50 },
              maxZoom: 14,
              duration: 1000
            });
          } else {
            console.warn('No valid coordinates found to fit bounds');
            map.flyTo({
              center: [78.4867, 17.3850], // Hyderabad center
              zoom: 11
            });
          }
        } else {
          console.warn('No markers created, cannot fit map bounds');
          showStatus('No markers could be created. Check coordinates in your data.', 'error');
        }
      }, 500);
    }
    
    function fetchDataAndBuildLayers() {
      showStatus('Loading facility data...', 'loading');
      console.log('Fetching facility data...');
      
      // URLs to try in sequence
      const urls = [
        'https://raw.githubusercontent.com/Vibraneum/facilty-data/main/facilities.json',
        // Add alternate URLs here as fallbacks
        './facilities.json' // Local file - include this if you've saved it locally
      ];
      
      // Try fetching from the first URL, then fall back to others if needed
      fetchWithFallback(urls, 0)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          console.log('Response received, parsing JSON...');
          return response.json();
        })
        .then(data => {
          console.log('JSON parsed successfully');
          
          // If data is in unexpected format, transform it
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            console.log('Converting object to array');
            // Handle case where data is an object instead of array
            if (data.facilities && Array.isArray(data.facilities)) {
              return data.facilities;
            }
            // Try to extract array if data is wrapped in another property
            for (const key in data) {
              if (Array.isArray(data[key])) {
                console.log(`Found array in property ${key}`);
                return data[key];
              }
            }
          }
          return data;
        })
        .then(data => {
          console.log('Data loaded successfully:', data.length, 'facilities');
          rawData = data;
          
          // Fallback if data is empty
          if (!data || data.length === 0) {
            console.warn('No facilities found in JSON, using sample data');
            rawData = generateSampleData();
          }
          
          // Convert array data to GeoJSON format
          const geojsonData = {
            type: 'FeatureCollection',
            features: rawData.map(item => ({
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
              },
              properties: {
                ...item
              }
            }))
          };
          
          // Add the facilities source with optimized clustering params
          map.addSource('facilities', {
            type: 'geojson',
            data: geojsonData,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 50,
            clusterProperties: {
              // Count sites by type
              hyderabad_count: ['+', ['case', ['==', ['get', 'type'], 'hyderabad-police'], 1, 0]],
              cyberabad_count: ['+', ['case', ['==', ['get', 'type'], 'cyberabad-police'], 1, 0]],
              // Count sites by tier
              vip_count: ['+', ['case', ['==', ['get', 'tier'], 'vip'], 1, 0]],
              platinum_count: ['+', ['case', ['==', ['get', 'tier'], 'platinum'], 1, 0]],
              gold_count: ['+', ['case', ['==', ['get', 'tier'], 'gold'], 1, 0]],
              silver_count: ['+', ['case', ['==', ['get', 'tier'], 'silver'], 1, 0]]
            }
          });
          
          // Add the layers
          addMapLayers();
          
          // Setup click events for clusters and points
          setupMapInteraction();
          
          // Enrich VIP data
          enrichWithVIPData(rawData);
          
          // Update stats and hide loader
          updateStats(rawData);
          loader.style.display = 'none';
          
          // Show success status
          showStatus(`Data loaded successfully (${rawData.length} facilities)`, 'success');
          
          // Fit map to all points
          fitBoundsToSource('facilities');
        })
        .catch(error => {
          console.error('Fetch error:', error);
          console.log('Falling back to sample data');
          
          // Use sample data if fetch fails
          rawData = generateSampleData();
          
          // Enrich with VIP data
          enrichWithVIPData(rawData);
          
          // Create direct markers instead of using GeoJSON source
          try {
            console.log('Creating markers directly for each facility');
            
            // Remove any existing markers
            markers.forEach(marker => marker.remove());
            markers = [];
            visibleMarkers = [];
            
            // Create a marker for each facility
            rawData.forEach(item => {
              console.log(`Creating marker for ${item.siteName} at ${item.latitude}, ${item.longitude}`);
              
              // Create marker element
              const el = document.createElement('div');
              el.className = `custom-marker ${item.type} ${item.tier}`;
              el.innerHTML = item.type === 'hyderabad-police' ? 'H' : 'C';
              
              // Create and store the marker
              const marker = new mapboxgl.Marker(el)
                .setLngLat([parseFloat(item.longitude), parseFloat(item.latitude)])
                .addTo(map);
              
              // Add click handler
              marker.getElement().addEventListener('click', () => {
                if (currentPopup) currentPopup.remove();
                
                // Create popup HTML
                const popupContent = createFacilityPopupHTML(item);
                
                currentPopup = new mapboxgl.Popup({
                  offset: 25,
                  closeButton: true,
                  closeOnClick: true,
                  maxWidth: '350px'
                })
                  .setLngLat([parseFloat(item.longitude), parseFloat(item.latitude)])
                  .setHTML(popupContent)
                  .addTo(map);
              });
              
              // Store marker
              markers.push(marker);
              visibleMarkers.push(marker);
            });
            
            // Update stats and hide loader
            updateStats(rawData);
            loader.style.display = 'none';
            
            // Show status
            showStatus(`Showing ${rawData.length} facilities (using fallback method)`, 'info');
            
            // Fit map to markers
            const bounds = new mapboxgl.LngLatBounds();
            rawData.forEach(item => {
              bounds.extend([parseFloat(item.longitude), parseFloat(item.latitude)]);
            });
            
            map.fitBounds(bounds, {
              padding: { top: 100, bottom: 100, left: 350, right: 50 },
              maxZoom: 14,
              duration: 1000
            });
            
          } catch (markerError) {
            console.error('Error creating markers:', markerError);
            
            // Ultimate fallback - use GeoJSON source
            console.log('Fallback to GeoJSON source');
            
            try {
              // Convert to GeoJSON
              const geojsonData = {
                type: 'FeatureCollection',
                features: rawData.map(item => ({
                  type: 'Feature',
                  geometry: {
                    type: 'Point',
                    coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
                  },
                  properties: {
                    ...item
                  }
                }))
              };
              
              console.log('Created GeoJSON data:', geojsonData);
              
              // Add the facilities source with sample data
              map.addSource('facilities', {
                type: 'geojson',
                data: geojsonData,
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50,
                clusterProperties: {
                  // Count sites by type
                  hyderabad_count: ['+', ['case', ['==', ['get', 'type'], 'hyderabad-police'], 1, 0]],
                  cyberabad_count: ['+', ['case', ['==', ['get', 'type'], 'cyberabad-police'], 1, 0]],
                  // Count sites by tier
                  vip_count: ['+', ['case', ['==', ['get', 'tier'], 'vip'], 1, 0]],
                  platinum_count: ['+', ['case', ['==', ['get', 'tier'], 'platinum'], 1, 0]],
                  gold_count: ['+', ['case', ['==', ['get', 'tier'], 'gold'], 1, 0]],
                  silver_count: ['+', ['case', ['==', ['get', 'tier'], 'silver'], 1, 0]]
                }
              });
              
              // Add layers
              addMapLayers();
              
              // Setup click events
              setupMapInteraction();
            } catch (geoJsonError) {
              console.error('Error with GeoJSON approach:', geoJsonError);
              showStatus(`Failed to display facilities: ${geoJsonError.message}`, 'error');
            }
          }
          
          // Update stats and hide loader
          updateStats(rawData);
          loader.style.display = 'none';
          
          // Show error status with detailed message
          showStatus(`Failed to fetch facilities.json: ${error.message}. Using sample data.`, 'error');
        });
    }

    function addMapLayers() {
      // Add a layer for the clusters
      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'facilities',
        filter: ['has', 'point_count'],
        paint: {
          // Size circles based on cluster size
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,   // Default radius of 20px
            5,    // If point_count >= 5
            25,   // radius = 25px
            10,   // If point_count >= 10
            30,   // radius = 30px
            20,   // If point_count >= 20
            35    // radius = 35px
          ],
          // Color circles based on cluster composition
          'circle-color': [
            'case',
            ['>', ['get', 'hyderabad_count'], ['get', 'cyberabad_count']], 
            'var(--hyderabad-color)',  // More Hyderabad police
            'var(--cyberabad-color)'   // More or equal Cyberabad police
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add a layer for cluster counts
      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'facilities',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': '{point_count_abbreviated}',
          'text-size': 14,
          'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold']
        },
        paint: {
          'text-color': '#ffffff'
        }
      });
      
      // Create a layer for individual points
      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-radius': 12,
          'circle-color': [
            'match',
            ['get', 'type'],
            'hyderabad-police', 'var(--hyderabad-color)',
            'cyberabad-police', 'var(--cyberabad-color)',
            '#ccc'  // fallback color
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#ffffff'
        }
      });
      
      // Add a symbol layer for individual points
      map.addLayer({
        id: 'unclustered-label',
        type: 'symbol',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'text-field': [
            'match',
            ['get', 'type'],
            'hyderabad-police', 'H',
            'cyberabad-police', 'C',
            'X'
          ],
          'text-size': 10,
          'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold']
        },
        paint: {
          'text-color': '#ffffff'
        }
      });
      
      // Add a second ring to show tier color for individual points
      map.addLayer({
        id: 'tier-indicator',
        type: 'circle',
        source: 'facilities',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-radius': 6,
          'circle-color': [
            'match',
            ['get', 'tier'],
            'vip', 'var(--vip-color)',
            'platinum', 'var(--platinum-color)',
            'gold', 'var(--gold-color)',
            'silver', 'var(--silver-color)',
            '#ccc'  // fallback color
          ],
          'circle-stroke-width': 1,
          'circle-stroke-color': '#ffffff',
          'circle-translate': [10, -10]
        }
      });
    }

    function setupMapInteraction() {
      // Click handler for clusters
      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        if (!features || features.length === 0) return;
        
        const clusterId = features[0].properties.cluster_id;
        
        // Get cluster expansion info
        map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          
          // Get cluster center
          const coordinates = features[0].geometry.coordinates.slice();
          
          // Create cluster popup content
          const hyderabadCount = features[0].properties.hyderabad_count || 0;
          const cyberabadCount = features[0].properties.cyberabad_count || 0;
          const vipCount = features[0].properties.vip_count || 0;
          const platinumCount = features[0].properties.platinum_count || 0;
          const goldCount = features[0].properties.gold_count || 0;
          const silverCount = features[0].properties.silver_count || 0;
          
          const popupContent = `
            <div class="custom-popup">
              <h3>Cluster Details</h3>
              <div class="popup-stats-grid">
                ${buildStatCard('fa-shield-alt', hyderabadCount, 'Hyderabad')}
                ${buildStatCard('fa-laptop-code', cyberabadCount, 'Cyberabad')}
                ${buildStatCard('fa-crown', vipCount, 'VIP')}
                ${buildStatCard('fa-medal', platinumCount, 'Platinum')}
                ${buildStatCard('fa-award', goldCount, 'Gold')}
                ${buildStatCard('fa-certificate', silverCount, 'Silver')}
              </div>
              <div style="text-align: center; margin-top: 10px;">
                <button id="zoom-to-cluster" style="background-color: var(--primary-light); color: white; 
                       border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                  <i class="fas fa-search-plus"></i> Zoom In
                </button>
              </div>
            </div>
          `;
          
          // Create and show popup
          if (currentPopup) currentPopup.remove();
          
          currentPopup = new mapboxgl.Popup({
            offset: 25,
            closeButton: true,
            closeOnClick: false,
            maxWidth: '350px'
          })
            .setLngLat(coordinates)
            .setHTML(popupContent)
            .addTo(map);
          
          // Add zoom button click handler
          setTimeout(() => {
            const zoomButton = document.getElementById('zoom-to-cluster');
            if (zoomButton) {
              zoomButton.addEventListener('click', () => {
                currentPopup.remove();
                map.flyTo({
                  center: coordinates,
                  zoom: zoom + 1,
                  duration: 1000
                });
              });
            }
          }, 100);
        });
      });
      
      // Hover effects for clusters
      map.on('mouseenter', 'clusters', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'clusters', () => {
        map.getCanvas().style.cursor = '';
      });
      
      // Click handler for individual points
      map.on('click', 'unclustered-point', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['unclustered-point'] });
        if (!features || features.length === 0) return;
        
        const properties = features[0].properties;
        const coordinates = features[0].geometry.coordinates.slice();
        
        // Format popup content based on site data
        const popupContent = createFacilityPopupHTML(properties);
        
        // Create popup
        if (currentPopup) currentPopup.remove();
        
        currentPopup = new mapboxgl.Popup({
          offset: 25,
          closeButton: true,
          closeOnClick: true,
          maxWidth: '350px'
        })
          .setLngLat(coordinates)
          .setHTML(popupContent)
          .addTo(map);
      });
      
      // Hover effects for points
      map.on('mouseenter', 'unclustered-point', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      
      map.on('mouseleave', 'unclustered-point', () => {
        map.getCanvas().style.cursor = '';
      });
    }

    // Create HTML for facility popup
    function createFacilityPopupHTML(properties) {
      // Parse string properties - JSON properties get stringified when in GeoJSON layers
      const squareFeet = parseInt(properties.squareFeet) || 0;
      const staff = parseInt(properties.staff) || 0;
      const chemicals = parseInt(properties.chemicals) || 0;
      const wasteVehicles = parseInt(properties.wasteVehicles) || 0;
      const machines = parseInt(properties.machines) || 0;
      
      // Format facility name
      const siteName = properties.siteName || 'Unknown Site';
      const siteType = properties.type || 'unknown';
      const siteTier = properties.tier || 'unknown';
      
      // Start building popup HTML
      let html = `<div class="custom-popup">`;
      
      // Header with site type icon and tier badge
      html += `
      <div class="popup-header-info">
        <span class="site-type-icon ${
          siteType === 'hyderabad-police' ? 'type-hyderabad-police' :
          siteType === 'cyberabad-police' ? 'type-cyberabad-police' : ''
        }">
          ${siteType === 'hyderabad-police' ? '<i class="fas fa-shield-alt"></i>' :
            siteType === 'cyberabad-police' ? '<i class="fas fa-laptop-code"></i>' :
            '<i class="fas fa-map-marker-alt"></i>'}
        </span>
        <h3>${siteName}</h3>
        <span class="popup-tier-badge ${siteTier}">
          ${siteTier === 'vip' ? '<i class="fas fa-crown"></i> VIP' :
            siteTier === 'platinum' ? '<i class="fas fa-medal"></i> Platinum' :
            siteTier === 'gold' ? '<i class="fas fa-award"></i> Gold' :
            '<i class="fas fa-certificate"></i> Silver'}
        </span>
      </div>`;

      // VIP sites get detailed statistics
      if (siteTier === 'vip') {
        html += `<div class="popup-stats-grid">`;
        // Core information
        html += buildStatCard('fa-chart-area', formatNumber(squareFeet) + ' sq ft', 'Area');
        
        // VIP-specific information
        if (staff) html += buildStatCard('fa-user', staff, 'Staff');
        if (chemicals) html += buildStatCard('fa-flask', chemicals, 'Chemicals');
        if (wasteVehicles) html += buildStatCard('fa-truck', wasteVehicles, 'Waste Veh');
        if (machines) html += buildStatCard('fa-cogs', machines, 'Machines');
        html += `</div>`;
      } else {
        // Non-VIP layout
        html += `<p><strong>Square Feet:</strong> ${formatNumber(squareFeet)} sq ft</p>`;
      }
      
      // Add address for all sites
      if (properties.address) {
        html += `<div class="popup-address"><i class="fas fa-map-marker-alt"></i> ${properties.address}</div>`;
      }

      html += `</div>`;
      
      return html;
    }

    // Build HTML for a stat card
    function buildStatCard(iconClass, value, label) {
      return `
        <div class="popup-stat-card">
          <div class="popup-stat-icon"><i class="fas ${iconClass}"></i></div>
          <div class="popup-stat-value">${value}</div>
          <div class="popup-stat-label">${label}</div>
        </div>
      `;
    }

    // Helper function to format numbers with commas
    function formatNumber(num) {
      if (!num) return 'N/A';
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Enrich sites with VIP data
    function enrichWithVIPData(data) {
      data.forEach(site => {
        // Check if site is VIP tier
        if (site.tier === 'vip') {
          // Get site name without "PS" suffix for matching
          const baseName = site.siteName ? site.siteName.replace(/\s*PS\s*$/, '') : 'Unknown';
          
          // Add VIP data if available, or generate sample data
          if (sampleVIPData[baseName]) {
            Object.assign(site, sampleVIPData[baseName]);
          } else {
            // Generate random data if no sample data exists
            site.staff = Math.floor(Math.random() * 30) + 20;
            site.supervisors = Math.floor(Math.random() * 5) + 2;
            site.managers = Math.floor(Math.random() * 2) + 1;
            site.area = site.squareFeet ? site.squareFeet + " sq ft" : Math.floor(Math.random() * 8000 + 7000) + " sq ft";
            site.chemicals = Math.floor(Math.random() * 10) + 5;
            site.wasteVehicles = Math.floor(Math.random() * 4) + 1;
            site.machines = Math.floor(Math.random() * 10) + 5;
          }
        }
      });
    }

    // Generate sample data if fetch fails
    function generateSampleData() {
      console.log('Generating sample data');
      const sampleData = [
        { siteName: "Saifabad PS", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004" },
        { siteName: "Begumpet PS", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016" },
        { siteName: "Charminar PS", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002" },
        { siteName: "Jubilee Hills PS", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
        { siteName: "Gachibowli PS", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
        { siteName: "Kukatpally PS", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
        { siteName: "Uppal PS", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
        { siteName: "Miyapur PS", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
        { siteName: "Madhapur PS", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
        { siteName: "LB Nagar PS", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" }
      ];
      
      // Log the sample data for verification
      console.log('Sample data generated:', sampleData.length, 'facilities');
      return sampleData;
    }
    
    // Add hardcoded sample data to ensure visualization works regardless of API
    const hardcodedFacilities = [
      { siteName: "Saifabad PS", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004", staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
      { siteName: "Begumpet PS", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016", staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
      { siteName: "Charminar PS", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002", staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 },
      { siteName: "Jubilee Hills PS", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
      { siteName: "Gachibowli PS", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
      { siteName: "Kukatpally PS", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
      { siteName: "Uppal PS", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
      { siteName: "Miyapur PS", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
      { siteName: "Madhapur PS", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
      { siteName: "LB Nagar PS", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" }
    ];

    // Helper function to fit map bounds to a source
    function fitBoundsToSource(sourceName) {
      const sourceFeatures = map.querySourceFeatures(sourceName);
      
      if (sourceFeatures.length === 0) {
        // Fallback to Hyderabad center if no features
        map.flyTo({
          center: [78.4867, 17.3850],
          zoom: 11
        });
        return;
      }
      
      const bounds = new mapboxgl.LngLatBounds();
      
      sourceFeatures.forEach(feature => {
        if (feature.geometry && feature.geometry.type === 'Point') {
          bounds.extend(feature.geometry.coordinates);
        }
      });
      
      map.fitBounds(bounds, {
        padding: { top: 100, bottom: 100, left: 350, right: 50 },
        maxZoom: 14,
        duration: 1000
      });
    }

    // Update statistics in sidebar
    function updateStats(data) {
      if (!data || !Array.isArray(data)) {
        statsContainer.innerHTML = '<p>No statistics available</p>';
        return;
      }
      
      // Count by type
      const typeCount = {
        'hyderabad-police': 0,
        'cyberabad-police': 0
      };
      
      // Count by tier
      const tierCount = {
        'vip': 0,
        'platinum': 0,
        'gold': 0,
        'silver': 0
      };
      
      // Calculate stats
      data.forEach(item => {
        if (item.type) typeCount[item.type] = (typeCount[item.type] || 0) + 1;
        if (item.tier) tierCount[item.tier] = (tierCount[item.tier] || 0) + 1;
      });
      
      // Generate HTML
      let html = `
        <div style="font-size: 14px; line-height: 1.6;">
          <p><strong>Total Facilities:</strong> ${data.length}</p>
          <p><strong>Types:</strong> 
            Hyderabad (${typeCount['hyderabad-police'] || 0}), 
            Cyberabad (${typeCount['cyberabad-police'] || 0})
          </p>
          <p><strong>Categories:</strong><br>
            <span style="color: var(--vip-color);"><i class="fas fa-crown"></i> VIP:</span> ${tierCount['vip'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-medal"></i> Platinum:</span> ${tierCount['platinum'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-award"></i> Gold:</span> ${tierCount['gold'] || 0}<br>
            <span style="color: #6c757d;"><i class="fas fa-certificate"></i> Silver:</span> ${tierCount['silver'] || 0}
          </p>
        </div>
      `;
      
      statsContainer.innerHTML = html;
    }

    // Show status message
    function showStatus(message, type = 'info') {
      statusText.textContent = message;
      statusIndicator.className = 'status-indicator';
      
      if (type === 'error') {
        statusIndicator.classList.add('error');
        statusIndicator.querySelector('i').className = 'fas fa-exclamation-circle';
      } else if (type === 'loading') {
        statusIndicator.querySelector('i').className = 'fas fa-spinner fa-spin';
      } else {
        statusIndicator.querySelector('i').className = 'fas fa-check-circle';
      }
      
      statusIndicator.classList.add('visible');
      
      // Hide after 5 seconds unless it's a loading message
      if (type !== 'loading') {
        setTimeout(() => {
          statusIndicator.classList.remove('visible');
        }, 5000);
      }
    }

    // Sample data button - direct marker creation bypassing GeoJSON
    document.getElementById('load-sample-data').addEventListener('click', () => {
      console.log('Manual sample data loading triggered');
      
      // Clear the global timeout since this is a manual action
      clearTimeout(globalTimeoutId);
      
      // Show loading status
      showStatus('Loading sample data...', 'loading');
      
      // Hide the main loader if it's still showing
      loader.style.display = 'none';
      
      // Clear any existing data layers
      try {
        if (map.getSource('facilities')) {
          if (map.getLayer('tier-indicator')) map.removeLayer('tier-indicator');
          if (map.getLayer('unclustered-label')) map.removeLayer('unclustered-label');
          if (map.getLayer('unclustered-point')) map.removeLayer('unclustered-point');
          if (map.getLayer('cluster-count')) map.removeLayer('cluster-count');
          if (map.getLayer('clusters')) map.removeLayer('clusters');
          map.removeSource('facilities');
        }
      } catch (e) {
        console.warn('Error cleaning up existing layers:', e);
      }
      
      // Remove any direct markers
      markers.forEach(marker => {
        try {
          marker.remove();
        } catch (e) {
          console.warn('Error removing marker:', e);
        }
      });
      markers = [];
      visibleMarkers = [];
      
      // Force the map to Streets style for better visibility
      try {
        map.setStyle('mapbox://styles/mapbox/streets-v11');
      } catch (e) {
        console.warn('Could not set map style:', e);
      }
      
      // Force-create our hardcoded markers
      setTimeout(() => {
        // Use the direct marker approach rather than GeoJSON
        console.log('Creating markers directly from hardcoded sample data');
        
        // Set up direct hardcoded police stations just in case JSON handling fails
        const emergencyData = [
          { siteName: "Saifabad Police Station", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004", staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
          { siteName: "Begumpet Police Station", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016", staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
          { siteName: "Charminar Police Station", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002", staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 },
          { siteName: "Jubilee Hills Police Station", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
          { siteName: "Gachibowli Police Station", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
          { siteName: "Kukatpally Police Station", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
          { siteName: "Uppal Police Station", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
          { siteName: "Miyapur Police Station", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
          { siteName: "Madhapur Police Station", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
          { siteName: "LB Nagar Police Station", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" }
        ];
        
        // Store raw data
        rawData = emergencyData;
        
        // Skip GeoJSON and create markers directly
        for (let i = 0; i < emergencyData.length; i++) {
          const item = emergencyData[i];
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          
          // Skip invalid coordinates
          if (isNaN(lat) || isNaN(lng)) continue;
          
          // Create marker element
          const el = document.createElement('div');
          el.className = `custom-marker ${item.type} ${item.tier}`;
          el.innerHTML = item.type === 'hyderabad-police' ? 'H' : 'C';
          el.setAttribute('title', item.siteName);
          
          // Create marker
          const marker = new mapboxgl.Marker({
            element: el,
            anchor: 'center'
          })
            .setLngLat([lng, lat])
            .addTo(map);
          
          // Add click handler
          marker.getElement().addEventListener('click', () => {
            if (currentPopup) currentPopup.remove();
            
            // Create popup HTML
            const popupContent = createFacilityPopupHTML(item);
            
            // Show popup
            currentPopup = new mapboxgl.Popup({
              offset: 25,
              closeButton: true,
              closeOnClick: true,
              maxWidth: '350px'
            })
              .setLngLat([lng, lat])
              .setHTML(popupContent)
              .addTo(map);
          });
          
          // Store marker reference
          markers.push(marker);
          visibleMarkers.push(marker);
        }
        
        // Create bounds and fit map to markers
        const bounds = new mapboxgl.LngLatBounds();
        emergencyData.forEach(item => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          if (!isNaN(lat) && !isNaN(lng)) {
            bounds.extend([lng, lat]);
          }
        });
        
        // Fit bounds
        map.fitBounds(bounds, {
          padding: { top: 100, bottom: 100, left: 350, right: 50 },
          maxZoom: 12,
          duration: 1000
        });
        
        // Update stats
        updateStats(emergencyData);
        
        // Update status
        showStatus(`Loaded ${emergencyData.length} police stations (sample data)`, 'success');
      }, 500);
    });
    
    // Sidebar toggle functionality
    sidebarTgl.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const icon = sidebarTgl.querySelector('i');
      if (sidebar.classList.contains('collapsed')) {
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
      } else {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
      }
      
      // Prevent the sidebar from disappearing completely
      setTimeout(() => {
        if (sidebar.style.display === 'none') {
          sidebar.style.display = 'block';
        }
      }, 100);
    });

    // Filter functionality
    const checkboxes = document.querySelectorAll('.checkbox-container input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        applyFilters();
      });
    });

    function applyFilters() {
      const activeTypes = [];
      const activeTiers = [];
      
      // Get selected filter values
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      // Create a combined filter expression for the map
      const typeFilter = ['in', ['get', 'type'], ...activeTypes];
      const tierFilter = ['in', ['get', 'tier'], ...activeTiers];
      
      // Apply filters to map layers for unclustered points
      const combinedFilter = ['all', typeFilter, tierFilter];
      
      map.setFilter('unclustered-point', ['all', ['!', ['has', 'point_count']], ...combinedFilter]);
      map.setFilter('unclustered-label', ['all', ['!', ['has', 'point_count']], ...combinedFilter]);
      map.setFilter('tier-indicator', ['all', ['!', ['has', 'point_count']], ...combinedFilter]);
      
      // Update source data to reflect filtered items
      // This will rebuild clusters based on filtered data
      const filteredData = {
        type: 'FeatureCollection',
        features: rawData
          .filter(item => activeTypes.includes(item.type) && activeTiers.includes(item.tier))
          .map(item => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
            },
            properties: { ...item }
          }))
      };
      
      map.getSource('facilities').setData(filteredData);
      
      // Show status message with count of visible features
      showStatus(`Showing ${filteredData.features.length} of ${rawData.length} facilities`, 'info');
    }

    // Search functionality
    searchBar.addEventListener('input', () => {
      const query = searchBar.value.trim().toLowerCase();
      
      if (query === '') {
        // If search is cleared, reset to showing all filtered facilities
        applyFilters();
        return;
      }
      
      // Filter by search query plus active checkboxes
      const activeTypes = [];
      const activeTiers = [];
      
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      const filteredData = {
        type: 'FeatureCollection',
        features: rawData
          .filter(item => {
            const nameMatch = item.siteName && item.siteName.toLowerCase().includes(query);
            const addressMatch = item.address && item.address.toLowerCase().includes(query);
            const typeMatch = activeTypes.includes(item.type);
            const tierMatch = activeTiers.includes(item.tier);
            
            return (nameMatch || addressMatch) && typeMatch && tierMatch;
          })
          .map(item => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
            },
            properties: { ...item }
          }))
      };
      
      map.getSource('facilities').setData(filteredData);
      
      // Update status
      showStatus(`Found ${filteredData.features.length} matches`, 'info');
      
      // If single result, zoom to it
      if (filteredData.features.length === 1) {
        const feature = filteredData.features[0];
        map.flyTo({
          center: feature.geometry.coordinates,
          zoom: 15,
          duration: 1000
        });
      } 
      // If multiple results but not too many, fit bounds
      else if (filteredData.features.length > 1 && filteredData.features.length < 50) {
        const bounds = new mapboxgl.LngLatBounds();
        filteredData.features.forEach(feature => {
          bounds.extend(feature.geometry.coordinates);
        });
        
        map.fitBounds(bounds, {
          padding: { top: 100, bottom: 100, left: 350, right: 50 },
          maxZoom: 14,
          duration: 1000
        });
      }
    });
  </script>
</body>
</html>
