<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ixora Facility Management - Facility Management Sites</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MAPBOX GL JS - Updated to specific working version -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --primary-color: #0056b3;
      --primary-light: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --body-bg: #f8f9fa;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition-speed: 0.3s;
      --primary-light-rgb: 0, 123, 255;

      /* Category colors */
      --vip-color: #ff4500;
      --platinum-color: #e5e4e2;
      --gold-color: #ffd700;
      --silver-color: #c0c0c0;

      /* Site type colors */
      --hyderabad-color: #3366cc;
      --cyberabad-color: #0099c6;
      --private-color: #9c27b0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--body-bg);
      color: var(--dark-color);
    }

    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .header {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
      padding: 15px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      max-width: 90%;
      text-align: center;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header img {
      height: 40px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .sidebar {
      position: absolute;
      top: 80px;
      left: 20px;
      bottom: 20px;
      width: 300px;
      z-index: 1000;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow-y: auto;
      transition: transform var(--transition-speed), background-color var(--transition-speed);
      transform: translateX(0);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .sidebar-content {
      padding: 20px;
    }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: -32px;
      width: 32px;
      height: 32px;
      background-color: var(--primary-light);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      transition: transform 0.2s ease;
    }
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    .sidebar.collapsed {
      transform: translateX(-280px) !important;
      min-width: 20px !important;
    }

    .filter-section {
      margin-bottom: 24px;
    }
    .filter-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      transition: color var(--transition-speed);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-section h3 i {
      color: var(--primary-light);
    }
    .checkbox-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.2s ease;
      margin-bottom: 6px;
    }
    .checkbox-item:hover {
      transform: translateX(5px);
    }
    .custom-checkbox {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .custom-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    .checkmark {
      height: 20px;
      width: 20px;
      background-color: #eee;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .custom-checkbox:hover input ~ .checkmark {
      background-color: #ccc;
    }
    .custom-checkbox input:checked ~ .checkmark {
      background-color: var(--primary-light);
    }
    .checkmark:after {
      content: "\f00c";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      display: none;
      font-size: 12px;
    }
    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #search-bar {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      background-color: var(--light-color);
      color: var(--dark-color);
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    #search-bar:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(var(--primary-light-rgb), 0.25);
    }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary-color);
      pointer-events: none;
    }

    /* Legend styles - improved positioning and interaction */
    .legend {
      position: absolute;
      bottom: 90px;
      right: 20px;
      z-index: 900;
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .legend h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
    }

    /* Add legend minimize button */
    .legend-minimize {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s ease;
    }

    .legend-minimize:hover {
      background-color: var(--primary-light);
      color: white;
    }

    .legend.minimized {
      transform: translateY(calc(100% - 40px));
      height: 40px;
      max-height: 40px;
      overflow: hidden;
    }

    .legend.minimized h3 {
      margin: 0;
      padding: 0;
      border: none;
    }

    .legend.minimized .legend-section {
      display: none;
    }

    /* Your existing legend styles - preserved */
    .legend-section {
      margin-bottom: 15px;
    }

    .legend-item, .legend-tier-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      transition: transform 0.2s ease;
    }

    .legend-item:hover, .legend-tier-item:hover {
      transform: translateX(5px);
    }

    .legend-color, .legend-tier-icon {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      flex-shrink: 0;
      transition: transform 0.2s ease;
      border: 2px solid white;
    }

    .legend-color:hover, .legend-tier-icon:hover {
      transform: scale(1.1);
    }

    .type-hyderabad-police { background-color: #3366cc; }
    .type-cyberabad-police { background-color: #0099c6; }
    .type-private-fm-clients { background-color: #9c27b0; }
    .tier-vip { background: linear-gradient(135deg, #ff4500, #ff6347); color: white; }
    .tier-platinum { background: linear-gradient(135deg, #e5e4e2, #ffffff); color: #333; }
    .tier-gold { background: linear-gradient(135deg, #ffd700, #FFF7CC); color: #333; }
    .tier-silver { background: linear-gradient(135deg, #c0c0c0, #E6E6E6); color: #333; }

    /* Improve map controls positioning to avoid overlap with legend */
    .mapboxgl-ctrl-top-right {
      top: 20px !important;
      right: 20px !important;
    }

    .mapboxgl-ctrl-bottom-right {
      bottom: 20px !important;
      right: 20px !important;
    }
    
    /* VIP Popup styling */
    .custom-popup {
      max-width: 350px;
      width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      color: #212529;
    }
    
    .custom-popup h3 {
      margin: 0 0 12px 0;
      color: #212529;
      font-size: 18px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .site-type-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      margin-right: 10px;
      flex-shrink: 0;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    .popup-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .popup-stat-card {
      background-color: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(0, 123, 255, 0.2);
    }
    
    .popup-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .popup-stat-icon {
      font-size: 18px;
      margin-bottom: 8px;
      color: #007bff;
    }
    
    .popup-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #212529;
    }
    
    .popup-stat-label {
      font-size: 12px;
      color: #6c757d;
      margin-top: 3px;
    }
    
    .popup-header-info {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .popup-tier-badge {
      background-color: #f8f9fa;
      border-radius: 20px;
      padding: 3px 8px;
      font-size: 12px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }
    
    .popup-tier-badge.vip {
      background-color: #ff4500;
      color: white;
    }
    
    .popup-tier-badge.platinum {
      background-color: #e5e4e2;
      color: #333;
    }
    
    .popup-tier-badge.gold {
      background-color: #ffd700;
      color: #333;
    }
    
    .popup-tier-badge.silver {
      background-color: #c0c0c0;
      color: #333;
    }

    .popup-address {
      background-color: rgba(0, 123, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      border-left: 3px solid #007bff;
      word-wrap: break-word;
    }
    
    .popup-address i {
      color: #007bff;
      margin-right: 5px;
    }

    .loader-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #007bff;
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text {
      color: #0056b3;
      font-size: 18px;
      font-weight: 500;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Custom Mapbox marker styles - Enhanced for visibility */
    .mapboxgl-marker {
      transition: transform 0.3s ease;
      z-index: 100 !important; /* Ensure markers are above other map elements */
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    .mapboxgl-marker:hover {
      transform: scale(1.2);
      z-index: 200 !important;
    }
    
    .custom-marker {
      width: 40px; /* Larger size */
      height: 40px;
      border-radius: 50%;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      color: white;
      font-weight: bold;
      font-size: 18px; /* Larger text */
      box-shadow: 0 3px 10px rgba(0,0,0,0.6); /* More pronounced shadow */
      border: 3px solid white; /* Thicker border */
      cursor: pointer;
      transition: transform 0.3s ease;
      position: relative;
    }
    
    .custom-marker:hover {
      transform: scale(1.2);
      box-shadow: 0 5px 15px rgba(0,0,0,0.7);
    }
    
    .custom-marker.hyderabad-police {
      background-color: #3366cc;
    }
    
    .custom-marker.cyberabad-police {
      background-color: #0099c6;
    }
    
    .custom-marker.private-fm-clients {
      background-color: #9c27b0;
    }
    
    /* Category indicators with enhanced visibility */
    .custom-marker.vip::after,
    .custom-marker.platinum::after,
    .custom-marker.gold::after,
    .custom-marker.silver::after {
      content: "";
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px; /* Larger indicator */
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 50;
    }
    
    .custom-marker.vip::after {
      background-color: #ff4500;
    }
    
    .custom-marker.platinum::after {
      background-color: #e5e4e2;
    }
    
    .custom-marker.gold::after {
      background-color: #ffd700;
    }
    
    .custom-marker.silver::after {
      background-color: #c0c0c0;
    }
    
    /* Status indicator */
    .status-indicator {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .status-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .status-indicator i {
      color: #28a745;
    }
    
    .status-indicator.error i {
      color: #dc3545;
    }
    
    /* Ensure popups have appropriate styling */
    .mapboxgl-popup-content {
      padding: 0 !important;
      overflow: hidden !important;
      max-width: 350px !important;
    }

    /* Fix for the cluster icons */
    .cluster-card {
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 250px;
    }
    
    .cluster-card h3 {
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
      font-size: 18px;
    }
    
    .cluster-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .cluster-stat {
      background-color: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .cluster-stat:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .cluster-stat-icon {
      font-size: 24px;
      margin-bottom: 10px;
      color: #007bff;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: rgba(0, 123, 255, 0.2);
    }
    
    .cluster-stat-value {
      font-size: 22px;
      font-weight: bold;
      color: #212529;
    }
    
    .cluster-stat-label {
      font-size: 14px;
      color: #6c757d;
      margin-top: 5px;
    }

    /* Responsive & smaller screens */
    @media (max-width: 768px) {
      .header {
        width: calc(100% - 40px);
        padding: 10px 15px;
      }
      .sidebar {
        width: 250px;
      }
      .legend {
        bottom: 10px;
        right: 10px;
        width: 200px;
      }
    }
    @media (max-width: 576px) {
      .header h1 {
        font-size: 16px;
      }
      .header img {
        height: 30px;
      }
      .sidebar.collapsed {
        transform: translateX(-240px) !important;
      }
    }
  </style>
</head>

<body>
  <div id="map-container">
    <!-- Loader -->
    <div class="loader-container" id="loader">
      <div class="loader"></div>
      <div class="loader-text">Loading facility data...</div>
    </div>

    <!-- Header -->
    <div class="header">
      <img src="https://raw.githubusercontent.com/Vibraneum/facilty-data/refs/heads/main/Ixora%20FM%20logo.png" alt="Ixora FM Logo">
      <h1>Ixora Facility Management - Facility Management Sites</h1>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </div>
      <div class="sidebar-content">
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="Search by site name...">
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-filter"></i> Site Types</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="hyderabad-police" checked data-type="hyderabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Hyderabad Police</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="cyberabad-police" checked data-type="cyberabad-police"/>
                <span class="checkmark"></span>
              </label>
              <span>Cyberabad Police</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="private-fm-clients" checked data-type="private-fm-clients"/>
                <span class="checkmark"></span>
              </label>
              <span>Private Clients</span>
            </div>
          </div>
        </div>

        <div class="filter-section">
          <h3><i class="fas fa-medal"></i> Site Category</h3>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="vip-tier" checked data-tier="vip"/>
                <span class="checkmark"></span>
              </label>
              <span>VIP</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="platinum-tier" checked data-tier="platinum"/>
                <span class="checkmark"></span>
              </label>
              <span>Platinum</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="gold-tier" checked data-tier="gold"/>
                <span class="checkmark"></span>
              </label>
              <span>Gold</span>
            </div>
            <div class="checkbox-item">
              <label class="custom-checkbox">
                <input type="checkbox" id="silver-tier" checked data-tier="silver"/>
                <span class="checkmark"></span>
              </label>
              <span>Silver</span>
            </div>
          </div>
        </div>
        
        <div class="filter-section">
          <h3><i class="fas fa-info-circle"></i> Statistics</h3>
          <div id="stats-container">
            Loading statistics...
          </div>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div class="legend" id="legend">
      <div class="legend-section">
        <h3>Site Types</h3>
        <div class="legend-item">
          <div class="legend-color type-hyderabad-police">
            <i class="fas fa-shield-alt"></i>
          </div>
          <span>Hyderabad Police</span>
        </div>
        <div class="legend-item">
          <div class="legend-color type-cyberabad-police">
            <i class="fas fa-laptop-code"></i>
          </div>
          <span>Cyberabad Police</span>
        </div>
        <div class="legend-item">
          <div class="legend-color type-private-fm-clients">
            <i class="fas fa-building"></i>
          </div>
          <span>Private Clients</span>
        </div>
      </div>
      
      <!-- Map Style Controls -->
      <div class="legend-section">
        <h3>Map Style</h3>
        <div id="map-styles" class="checkbox-container">
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="streets-v11" type="radio" name="rtoggle" checked="checked">
              <span class="checkmark"></span>
            </label>
            <span>Streets</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="light-v10" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Light</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="dark-v10" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Dark</span>
          </div>
          <div class="checkbox-item">
            <label class="custom-checkbox">
              <input id="satellite-v9" type="radio" name="rtoggle">
              <span class="checkmark"></span>
            </label>
            <span>Satellite</span>
          </div>
        </div>
      </div>
    <!-- "Reload All Data" button -->
    <div class="legend-section" style="margin: 20px 0; text-align: center;">
        <button id="load-sample-data" style="background-color: #007bff; color: white; 
               border: none; padding: 12px 15px; border-radius: 4px; cursor: pointer;
               width: 100%; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
               font-size: 14px; display: flex; align-items: center; justify-content: center;
               gap: 8px;">
          <i class="fas fa-sync-alt" style="font-size: 18px;"></i> 
          <span>RELOAD ALL DATA</span>
        </button>
        <div style="font-size: 12px; margin-top: 5px; color: #555;">
          Shows all 274 facilities
        </div>
      </div>
      
      <div class="legend-section">
        <h3>Site Categories</h3>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-vip">V</div>
          <span>VIP Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-platinum">P</div>
          <span>Platinum Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-gold">G</div>
          <span>Gold Tier</span>
        </div>
        <div class="legend-tier-item">
          <div class="legend-tier-icon tier-silver">S</div>
          <span>Silver Tier</span>
        </div>
      </div>
    </div>
    
    <!-- Status Indicator -->
    <div class="status-indicator" id="status-indicator">
      <i class="fas fa-check-circle"></i>
      <span id="status-text">Data loaded successfully</span>
    </div>

    <div id="map"></div>
  </div>

  <script>
    // Use your actual Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoidmVkYW50aG5hdGgiLCJhIjoiY203c3lsOWZyMGs4MzJpcmJoZTY1Ync4bSJ9.Hx83V0-qM8JOmh4y_SSXCw';

    // Sample VIP data for enrichment when needed
    const sampleVIPData = {
      "OFFICE OF THE COMMISSIONER OF POLICE(OLD)": { staff: 220, chemicals: 450, wasteVehicles: 10, machines: 20 },
      "SAIFABAD": { staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
      "BEGUMPET": { staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
      "CHARMINAR": { staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 },
      "PULLELA GOPICHAND BADMINTON ACADEMY": { staff: 30, chemicals: 9, wasteVehicles: 0, machines: 4 }
    };

    // Hard-coded sample data for immediate fallback
    const EMERGENCY_DATA = [
      { siteName: "Saifabad Police Station", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004", staff: 45, chemicals: 12, wasteVehicles: 4, machines: 15 },
      { siteName: "Begumpet Police Station", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016", staff: 38, chemicals: 9, wasteVehicles: 3, machines: 12 },
      { siteName: "Charminar Police Station", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002", staff: 52, chemicals: 15, wasteVehicles: 5, machines: 18 },
      { siteName: "Jubilee Hills Police Station", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
      { siteName: "Gachibowli Police Station", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
      { siteName: "Kukatpally Police Station", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
      { siteName: "Uppal Police Station", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
      { siteName: "Miyapur Police Station", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
      { siteName: "Madhapur Police Station", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
      { siteName: "LB Nagar Police Station", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" },
      { siteName: "Pullela Gopichand Badminton Academy", latitude: 17.438295, longitude: 78.349139, type: "private-fm-clients", tier: "platinum", squareFeet: 30000, address: "Pullela Gopichand Badminton Academy, Hyderabad", staff: 30, chemicals: 9, wasteVehicles: 0, machines: 4 }
    ];

    // UI Elements
    const loader = document.getElementById('loader');
    const sidebar = document.getElementById('sidebar');
    const sidebarTgl = document.getElementById('sidebar-toggle');
    const searchBar = document.getElementById('search-bar');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const statsContainer = document.getElementById('stats-container');

    // Initialize with NO failsafe timer
    let rawData = null;        // store fetched JSON
    let currentPopup = null;   // track open popup
    let markers = [];          // store all markers
    let visibleMarkers = [];   // track which markers are visible
    let mapInitialized = false; // track if map is fully initialized
    let currentMapStyle = 'streets-v11'; // Track current map style

    // Create the map with improved style
    console.log('Initializing map...');
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11', // Streets style for better visibility
      center: [78.4867, 17.3850], // Hyderabad center
      zoom: 11,
      pitch: 0, // Reduce 3D effects for stability
      bearing: 0
    });

    // Make sure mapboxgl is defined
    if (typeof mapboxgl === 'undefined') {
      console.error('Mapbox GL JS is not loaded. Check your internet connection or try a different browser.');
      alert('Mapbox GL JS failed to load. Please check your internet connection and reload the page.');
    }
    
    // Set a global timeout to ensure we show data even if all fetches fail
    const globalTimeoutId = setTimeout(() => {
      console.warn('Global timeout reached, forcing sample data load');
      // If loader is still visible, it means data hasn't loaded yet
      if (loader.style.display !== 'none') {
        document.getElementById('load-sample-data').click();
      }
    }, 10000); // 10 second global timeout

    // Handle potential map initialization errors
    try {
      // Do an immediate load of sample data if needed
      const urlParams = new URLSearchParams(window.location.search);
      const directLoad = urlParams.get('load') === 'sample';
      
      map.on('load', () => {
        console.log('Map has loaded. Setting up...');
        mapInitialized = true;
        
        // Create a debug status display
        showStatus('Map loaded successfully. Setting up controls...', 'success');
        
        // Add navigation controls with improved positioning
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        
        // Add fullscreen control
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
        
        // Add geolocate control
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: {enableHighAccuracy: true},
            trackUserLocation: true,
            showUserHeading: true
          }), 
          'top-right'
        );
        
        // Check if we should immediately load sample data (for testing)
        if (directLoad) {
          console.log('Direct sample data loading triggered by URL parameter');
          setTimeout(() => {
            document.getElementById('load-sample-data').click();
          }, 1000);
        } else {
          // Fetch data normally
          fetchDataAndBuildLayers();
        }
      });
      
      // Add map style change event handler
      map.on('style.load', () => {
        console.log('Map style loaded/changed');
        mapInitialized = true;
        
        // If we have markers but changed style, recreate them to ensure visibility
        if (markers.length > 0 && rawData) {
          console.log('Recreating markers after style change');
          setTimeout(() => createDirectMarkers(rawData), 500);
        }
      });
    } catch (error) {
      console.error('Error initializing map:', error);
      alert('Failed to initialize the map. Please try refreshing the page or use the "Load Sample Data" button.');
    }

    // Fixed: fetchWithFallback function now returns a proper Promise
    function fetchWithFallback(urls, index = 0) {
      return new Promise((resolve, reject) => {
        if (index >= urls.length) {
          console.error('All URLs failed, using sample data');
          resolve(generateSampleData());
          return;
        }
        
        console.log(`Trying URL ${index + 1}/${urls.length}: ${urls[index]}`);
        
        // Add a timeout to prevent hanging
        const timeoutId = setTimeout(() => {
          console.warn(`Fetch timeout for ${urls[index]}`);
          fetchWithFallback(urls, index + 1)
            .then(resolve)
            .catch(reject);
        }, 5000); // 5 second timeout
        
        fetch(urls[index], {
          headers: {
            'Accept': 'application/json'
          },
          cache: 'no-cache'
        })
        .then(response => {
          clearTimeout(timeoutId); // Clear the timeout
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          console.log('Response received, parsing JSON...');
          return response.json();
        })
        .then(data => {
          console.log('JSON parsed successfully');
          resolve(data);
        })
        .catch(error => {
          clearTimeout(timeoutId); // Clear the timeout
          console.error(`Failed to fetch from ${urls[index]}:`, error);
          // Try the next URL
          fetchWithFallback(urls, index + 1)
            .then(resolve)
            .catch(reject);
        });
      });
    }
      
    // Process the data once we have it
    function processData(data) {
      console.log('Processing data:', data ? (Array.isArray(data) ? data.length + ' items' : 'object') : 'null');
      
      // Clear the global timeout since we got data
      clearTimeout(globalTimeoutId);
      
      // If data is in unexpected format, transform it
      if (data && typeof data === 'object' && !Array.isArray(data)) {
        console.log('Converting object to array');
        // Handle case where data is an object instead of array
        if (data.facilities && Array.isArray(data.facilities)) {
          data = data.facilities;
        } else {
          // Try to extract array if data is wrapped in another property
          for (const key in data) {
            if (Array.isArray(data[key])) {
              console.log(`Found array in property ${key}`);
              data = data[key];
              break;
            }
          }
        }
      }
      
      // Fallback if data is empty or not an array
      if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn('Invalid or empty data, using sample data');
        data = generateSampleData();
      }
      
      rawData = data;
      
      // Enrich with VIP data
      enrichWithVIPData(rawData);
      
      // Try direct marker approach which is more reliable
      console.log('Using direct marker approach for most reliability');
      createDirectMarkers(rawData);
      
      // Update stats and hide loader
      updateStats(rawData);
      loader.style.display = 'none';
      
      // Show success message
      showStatus(`Data loaded successfully (${rawData.length} facilities)`, 'success');
    }
    
    // Directly create markers without relying on GeoJSON - most reliable approach
    function createDirectMarkers(data) {
      if (!mapInitialized) {
        console.log('Map not initialized yet, waiting...');
        setTimeout(() => createDirectMarkers(data), 100);
        return;
      }
      
      console.log('Creating direct markers for', data.length, 'facilities');
      
      // Remove any existing markers
      markers.forEach(marker => {
        try {
          marker.remove();
        } catch (e) {
          console.warn('Error removing marker:', e);
        }
      });
      
      markers = [];
      visibleMarkers = [];
      
      // Create a marker for each facility
      data.forEach((item, index) => {
        try {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          
          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`Invalid coordinates for ${item.siteName}: ${item.latitude}, ${item.longitude}`);
            return;
          }
          
          // Create marker element
          const el = document.createElement('div');
          el.className = `custom-marker ${item.type || 'unknown'} ${item.tier || 'unknown'}`;
          
          // Set marker text based on type
          if (item.type === 'hyderabad-police') {
            el.innerHTML = 'H';
          } else if (item.type === 'cyberabad-police') {
            el.innerHTML = 'C';
          } else if (item.type === 'private-fm-clients') {
            el.innerHTML = 'P';
          } else {
            el.innerHTML = '?';
          }
          
          el.style.zIndex = '999'; // Ensure high z-index
          
          // Create and add the marker
          const marker = new mapboxgl.Marker({
            element: el,
            anchor: 'center'
          })
            .setLngLat([lng, lat])
            .addTo(map);
          
          // Add click handler
          marker.getElement().addEventListener('click', () => {
            if (currentPopup) currentPopup.remove();
            
            // Create popup HTML
            const popupContent = createFacilityPopupHTML(item);
            
            // Show popup
            currentPopup = new mapboxgl.Popup({
              offset: 25,
              closeButton: true,
              closeOnClick: true,
              maxWidth: '350px'
            })
              .setLngLat([lng, lat])
              .setHTML(popupContent)
              .addTo(map);
          });
          
          // Store marker references
          markers.push(marker);
          visibleMarkers.push(marker);
        } catch (e) {
          console.error(`Error creating marker for ${item.siteName || 'Unknown'}:`, e);
        }
      });
      
      console.log(`Successfully created ${markers.length} markers`);
      
      // If we have markers, fit the map to them
      if (markers.length > 0) {
        const bounds = new mapboxgl.LngLatBounds();
        
        data.forEach(item => {
          const lat = parseFloat(item.latitude);
          const lng = parseFloat(item.longitude);
          if (!isNaN(lat) && !isNaN(lng)) {
            bounds.extend([lng, lat]);
          }
        });
        
        if (!bounds.isEmpty()) {
          console.log('Fitting map to bounds');
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 350, right: 50 },
            maxZoom: 13,
            duration: 1000
          });
        }
      }
      
      // Apply any active filters
      applyFilters();
      
      return markers.length > 0;
    }
    
    // Fixed: fetchDataAndBuildLayers function with proper Promise handling
    function fetchDataAndBuildLayers() {
      showStatus('Loading facility data...', 'loading');
      console.log('Fetching facility data...');
      
      // URLs to try in sequence
      const urls = [
        'https://raw.githubusercontent.com/Vibraneum/facilty-data/main/facilities.json',
        // Add alternate URLs here as fallbacks
        './facilities.json' // Local file - include this if you've saved it locally
      ];
      
      // Try fetching from the first URL, then fall back to others if needed
      fetchWithFallback(urls)
        .then(data => {
          console.log('Data loaded successfully:', typeof data, Array.isArray(data) ? data.length + ' items' : 'object');
          
          // If data is in unexpected format, transform it
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            console.log('Converting object to array');
            // Handle case where data is an object instead of array
            if (data.facilities && Array.isArray(data.facilities)) {
              return data.facilities;
            }
            // Try to extract array if data is wrapped in another property
            for (const key in data) {
              if (Array.isArray(data[key])) {
                console.log(`Found array in property ${key}`);
                return data[key];
              }
            }
          }
          return data;
        })
        .then(processData)
        .catch(error => {
          console.error('All fetch attempts failed:', error);
          // Use sample data as last resort
          processData(generateSampleData());
        });
    }

    // Fixed: Properly defined enrichWithVIPData function
    function enrichWithVIPData(data) {
      if (!data || !Array.isArray(data)) {
        console.warn('Invalid data provided to enrichWithVIPData');
        return;
      }
      
      data.forEach(site => {
        // Skip if not a VIP or Platinum tier
        if (site.tier !== 'vip' && site.tier !== 'platinum') return;
        
        // Get site name without suffixes for matching
        let baseName = site.siteName || '';
        baseName = baseName.replace(/\s*(PS|Police Station)\s*$/i, '').trim().toUpperCase();
        
        // Try to match with sampleVIPData
        let matched = false;
        for (const key in sampleVIPData) {
          if (baseName.includes(key) || key.includes(baseName)) {
            // Only set properties that don't already exist
            if (!site.staff) site.staff = sampleVIPData[key].staff;
            if (!site.chemicals) site.chemicals = sampleVIPData[key].chemicals;
            if (!site.wasteVehicles) site.wasteVehicles = sampleVIPData[key].wasteVehicles;
            if (!site.machines) site.machines = sampleVIPData[key].machines;
            matched = true;
            break;
          }
        }
        
        // If no match, generate random data
        if (!matched) {
          site.staff = site.staff || Math.floor(Math.random() * 30) + 20;
          site.chemicals = site.chemicals || Math.floor(Math.random() * 10) + 5;
          site.wasteVehicles = site.wasteVehicles || Math.floor(Math.random() * 4) + 1;
          site.machines = site.machines || Math.floor(Math.random() * 10) + 5;
        }
      });
    }

    // Create HTML for facility popup with improved formatting
    function createFacilityPopupHTML(properties) {
      // Parse string properties - JSON properties get stringified when in GeoJSON layers
      let props = properties;
      
      // If properties come from GeoJSON, they might be stringified
      if (typeof properties === 'string') {
        try {
          props = JSON.parse(properties);
        } catch (e) {
          console.error('Error parsing properties:', e);
        }
      }
      
      const squareFeet = parseInt(props.squareFeet) || 0;
      const staff = parseInt(props.staff) || 0;
      const chemicals = parseInt(props.chemicals) || 0;
      const wasteVehicles = parseInt(props.wasteVehicles) || 0;
      const machines = parseInt(props.machines) || 0;
      
      // Format facility name
      const siteName = props.siteName || 'Unknown Site';
      const siteType = props.type || 'unknown';
      const siteTier = props.tier || 'unknown';
      
      // Start building popup HTML with improved formatting
      let html = `<div class="custom-popup" style="width: 100%; max-width: 350px; word-wrap: break-word;">`;
      
      // Header with site type icon and tier badge
      html += `
      <div class="popup-header-info" style="display: flex; align-items: center; margin-bottom: 10px;">
        <span class="site-type-icon" style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; color: white; margin-right: 10px; flex-shrink: 0; font-size: 18px; box-shadow: 0 3px 6px rgba(0,0,0,0.2); background-color: ${
          siteType === 'hyderabad-police' ? '#3366cc' :
          siteType === 'cyberabad-police' ? '#0099c6' : 
          siteType === 'private-fm-clients' ? '#9c27b0' : '#cccccc'
        }">
          ${siteType === 'hyderabad-police' ? '<i class="fas fa-shield-alt"></i>' :
            siteType === 'cyberabad-police' ? '<i class="fas fa-laptop-code"></i>' :
            siteType === 'private-fm-clients' ? '<i class="fas fa-building"></i>' :
            '<i class="fas fa-map-marker-alt"></i>'}
        </span>
        <h3 style="margin: 0; font-size: 16px; flex-grow: 1; overflow: hidden; text-overflow: ellipsis;">${siteName}</h3>
        <span class="popup-tier-badge" style="background-color: ${
          siteTier === 'vip' ? '#ff4500' :
          siteTier === 'platinum' ? '#e5e4e2' :
          siteTier === 'gold' ? '#ffd700' :
          siteTier === 'silver' ? '#c0c0c0' : '#f8f9fa'
        }; color: ${
          siteTier === 'vip' ? 'white' : '#333'
        }; border-radius: 20px; padding: 3px 8px; font-size: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; margin-left: auto;">
          ${siteTier === 'vip' ? '<i class="fas fa-crown"></i> VIP' :
            siteTier === 'platinum' ? '<i class="fas fa-medal"></i> Platinum' :
            siteTier === 'gold' ? '<i class="fas fa-award"></i> Gold' :
            '<i class="fas fa-certificate"></i> Silver'}
        </span>
      </div>`;

      // VIP sites get detailed statistics with improved formatting
      if (siteTier === 'vip' || siteTier === 'platinum') {
        html += `<div class="popup-stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">`;
        // Core information
        html += buildStatCard('fa-chart-area', formatNumber(squareFeet) + ' sq ft', 'Area');
        
        // VIP-specific information
        if (staff) html += buildStatCard('fa-user', staff, 'Staff');
        if (chemicals) html += buildStatCard('fa-flask', chemicals, 'Chemicals');
        if (wasteVehicles) html += buildStatCard('fa-truck', wasteVehicles, 'Waste Veh');
        if (machines) html += buildStatCard('fa-cogs', machines, 'Machines');
        html += `</div>`;
      } else {
        // Non-VIP layout
        html += `<p style="margin: 10px 0;"><strong>Square Feet:</strong> ${formatNumber(squareFeet)} sq ft</p>`;
      }
      
      // Add address for all sites with improved word wrapping
      if (props.address) {
        html += `<div class="popup-address" style="background-color: rgba(0, 123, 255, 0.05); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; border-left: 3px solid #007bff; word-wrap: break-word;">
          <i class="fas fa-map-marker-alt" style="color: #007bff; margin-right: 5px;"></i> ${props.address}
        </div>`;
      }

      html += `</div>`;
      
      return html;
    }

    // Build HTML for a stat card with improved styling
    function buildStatCard(iconClass, value, label) {
      return `
        <div class="popup-stat-card" style="background-color: rgba(0, 123, 255, 0.1); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid rgba(0, 123, 255, 0.2);">
          <div class="popup-stat-icon" style="font-size: 18px; margin-bottom: 8px; color: #007bff;"><i class="fas ${iconClass}"></i></div>
          <div class="popup-stat-value" style="font-size: 16px; font-weight: bold; color: #212529;">${value}</div>
          <div class="popup-stat-label" style="font-size: 12px; color: #6c757d; margin-top: 3px;">${label}</div>
        </div>
      `;
    }

    // Helper function to format numbers with commas
    function formatNumber(num) {
      if (!num) return 'N/A';
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Generate sample data if fetch fails
    function generateSampleData() {
      console.log('Generating sample data');
      return EMERGENCY_DATA;
    }

    // Helper function to fit map bounds to a source
    function fitBoundsToSource(sourceName) {
      try {
        const sourceFeatures = map.querySourceFeatures(sourceName);
        
        if (sourceFeatures.length === 0) {
          // Fallback to Hyderabad center if no features
          map.flyTo({
            center: [78.4867, 17.3850],
            zoom: 11
          });
          return;
        }
        
        const bounds = new mapboxgl.LngLatBounds();
        
        sourceFeatures.forEach(feature => {
          if (feature.geometry && feature.geometry.type === 'Point') {
            bounds.extend(feature.geometry.coordinates);
          }
        });
        
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 350, right: 50 },
            maxZoom: 14,
            duration: 1000
          });
        }
      } catch (error) {
        console.error('Error fitting bounds:', error);
        // Fallback to Hyderabad center
        map.flyTo({
          center: [78.4867, 17.3850],
          zoom: 11
        });
      }
    }

    // Update statistics in sidebar
    // CORRECTED VERSION:
function updateStats(data) { // Open curly brace
  if (!data || !Array.isArray(data)) {
    statsContainer.innerHTML = '<p>No statistics available</p>';
    return;
  }
  
  // Count by type
  const typeCount = {
    'hyderabad-police': 0,
    'cyberabad-police': 0,
    'private-fm-clients': 0
  };
  
  // Count by tier
  const tierCount = {
    'vip': 0,
    'platinum': 0,
    'gold': 0,
    'silver': 0
  };
  
  // Calculate stats
  data.forEach(item => {
    if (item.type) typeCount[item.type] = (typeCount[item.type] || 0) + 1;
    if (item.tier) tierCount[item.tier] = (tierCount[item.tier] || 0) + 1;
  });
  
  // Generate HTML
  let html = `
    <div style="font-size: 14px; line-height: 1.6;">
      <p><strong>Total Facilities:</strong> ${data.length}</p>
      <p><strong>Types:</strong><br>
        <span style="color: #3366cc;"><i class="fas fa-shield-alt"></i> Hyderabad Police:</span> ${typeCount['hyderabad-police'] || 0}<br>
        <span style="color: #0099c6;"><i class="fas fa-laptop-code"></i> Cyberabad Police:</span> ${typeCount['cyberabad-police'] || 0}<br>
        <span style="color: #9c27b0;"><i class="fas fa-building"></i> Private Clients:</span> ${typeCount['private-fm-clients'] || 0}
      </p>
      <p><strong>Categories:</strong><br>
        <span style="color: #ff4500;"><i class="fas fa-crown"></i> VIP:</span> ${tierCount['vip'] || 0}<br>
        <span style="color: #6c757d;"><i class="fas fa-medal"></i> Platinum:</span> ${tierCount['platinum'] || 0}<br>
        <span style="color: #6c757d;"><i class="fas fa-award"></i> Gold:</span> ${tierCount['gold'] || 0}<br>
        <span style="color: #6c757d;"><i class="fas fa-certificate"></i> Silver:</span> ${tierCount['silver'] || 0}
      </p>
    </div>
  `;
  
  statsContainer.innerHTML = html;
} // Close curly brace for the function
      

    // Show status message
    function showStatus(message, type = 'info') {
      statusText.textContent = message;
      statusIndicator.className = 'status-indicator';
      
      if (type === 'error') {
        statusIndicator.classList.add('error');
        statusIndicator.querySelector('i').className = 'fas fa-exclamation-circle';
      } else if (type === 'loading') {
        statusIndicator.querySelector('i').className = 'fas fa-spinner fa-spin';
      } else {
        statusIndicator.querySelector('i').className = 'fas fa-check-circle';
      }
      
      statusIndicator.classList.add('visible');
      
      // Hide after 5 seconds unless it's a loading message
      if (type !== 'loading') {
        setTimeout(() => {
          statusIndicator.classList.remove('visible');
        }, 5000);
      }
    }

    // Fixed: Create a robust fetchFacilityData function for the "RELOAD ALL DATA" button
    function fetchFacilityData() {
      console.log('Loading full dataset...');
      
      // Show loading status
      showStatus('Loading all facilities...', 'loading');
      
      // URLs to try in sequence
      const urls = [
        'https://raw.githubusercontent.com/Vibraneum/facilty-data/main/facilities.json',
        './facilities.json' // Local file
      ];
      
      // Try fetching with proper Promise handling
      fetchWithFallback(urls)
        .then(data => {
          console.log('Facility data loaded successfully:', data.length, 'items');
          processData(data);
          return true;
        })
        .catch(error => {
          console.error('Error loading facility data:', error);
          
          // If we have previous data, reuse it instead of emergency data
          if (rawData && rawData.length > 0) {
            console.log('Reusing existing data');
            processData(rawData);
          } else {
            // Use emergency data as last resort
            console.log('Using emergency data');
            processData(generateSampleData());
          }
          
          showStatus(`Failed to load data: ${error.message}. Using previous/emergency data.`, 'error');
          return false;
        });
    }

    // Sample data button now loads the full dataset
    document.getElementById('load-sample-data').addEventListener('click', () => {
      fetchFacilityData();
    });
    
    // Fixed: Sidebar toggle functionality
    sidebarTgl.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const icon = sidebarTgl.querySelector('i');
      
      if (sidebar.classList.contains('collapsed')) {
        icon.classList.remove('fa-chevron-left');
        icon.classList.add('fa-chevron-right');
        sidebar.style.transform = 'translateX(-280px)';
        sidebar.style.minWidth = '20px'; // Ensure a small portion remains visible
      } else {
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-left');
        sidebar.style.transform = 'translateX(0)';
      }
    });

    // Improved Filter functionality
    function applyFilters() {
      const activeTypes = [];
      const activeTiers = [];
      
      // Get selected filter values
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      console.log('Applying filters:', 'Types:', activeTypes, 'Tiers:', activeTiers);
      
      // Reset visible markers count
      visibleMarkers = [];
      
      // Apply direct filtering to markers
      markers.forEach((marker, index) => {
        if (!rawData || index >= rawData.length) return;
        
        const item = rawData[index];
        const typeMatch = activeTypes.includes(item.type);
        const tierMatch = activeTiers.includes(item.tier);
        
        if (typeMatch && tierMatch) {
          marker.getElement().style.display = '';
          visibleMarkers.push(marker);
        } else {
          marker.getElement().style.display = 'none';
        }
      });
      
      console.log(`Filter applied: ${visibleMarkers.length} of ${markers.length} markers visible`);
      showStatus(`Showing ${visibleMarkers.length} of ${markers.length} facilities`, 'info');
    }

    // Filter checkboxes
    const checkboxes = document.querySelectorAll('.checkbox-container input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        applyFilters();
      });
    });

    // Fixed Search functionality
    searchBar.addEventListener('input', () => {
      const query = searchBar.value.trim().toLowerCase();
      
      // Reset if empty query
      if (query === '') {
        // Make all markers visible (subject to filters)
        applyFilters();
        return;
      }
      
      console.log(`Searching for "${query}" among ${markers.length} markers`);
      
      // Get active filters
      const activeTypes = [];
      const activeTiers = [];
      
      checkboxes.forEach(cb => {
        if (cb.checked) {
          if (cb.dataset.type) activeTypes.push(cb.dataset.type);
          if (cb.dataset.tier) activeTiers.push(cb.dataset.tier);
        }
      });
      
      // Clear visible markers array
      visibleMarkers = [];
      
      // Filter markers directly with improved matching
      let matchCount = 0;
      markers.forEach((marker, index) => {
        if (!rawData || index >= rawData.length) return;
        
        const item = rawData[index];
        const nameMatch = item.siteName && item.siteName.toLowerCase().includes(query);
        const addressMatch = item.address && item.address.toLowerCase().includes(query);
        const typeMatch = activeTypes.includes(item.type);
        const tierMatch = activeTiers.includes(item.tier);
        
        if ((nameMatch || addressMatch) && typeMatch && tierMatch) {
          matchCount++;
          marker.getElement().style.display = ''; // Using empty string is more reliable
          visibleMarkers.push(marker);
        } else {
          marker.getElement().style.display = 'none';
        }
      });
      
      console.log(`Found ${matchCount} matches for "${query}"`);
      
      // Update status
      showStatus(`Found ${visibleMarkers.length} matches for "${query}"`, 'info');
      
      // If single result, zoom to it
      if (visibleMarkers.length === 1) {
        const markerIndex = markers.indexOf(visibleMarkers[0]);
        if (markerIndex !== -1 && rawData && markerIndex < rawData.length) {
          const item = rawData[markerIndex];
          map.flyTo({
            center: [parseFloat(item.longitude), parseFloat(item.latitude)],
            zoom: 15,
            duration: 1000
          });
        }
      } 
      // If multiple results but not too many, fit bounds
      else if (visibleMarkers.length > 1 && visibleMarkers.length < 50) {
        const bounds = new mapboxgl.LngLatBounds();
        
        visibleMarkers.forEach(marker => {
          bounds.extend(marker.getLngLat());
        });
        
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, {
            padding: { top: 100, bottom: 100, left: 350, right: 50 },
            maxZoom: 14,
            duration: 1000
          });
        }
      }
    });

    // Improved cluster popup content
    function createClusterPopupHTML(hyderabadCount, cyberabadCount, privateCount, vipCount, platinumCount, goldCount, silverCount) {
      let html = `
      <div class="cluster-card">
        <h3>Cluster Details</h3>
        <div class="cluster-stats">
          <!-- First row: site types -->
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(51, 102, 204, 0.2); color: #3366cc;">
              <i class="fas fa-shield-alt"></i>
            </div>
            <div class="cluster-stat-value">${hyderabadCount}</div>
            <div class="cluster-stat-label">Hyderabad</div>
          </div>
          
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(0, 153, 198, 0.2); color: #0099c6;">
              <i class="fas fa-laptop-code"></i>
            </div>
            <div class="cluster-stat-value">${cyberabadCount}</div>
            <div class="cluster-stat-label">Cyberabad</div>
          </div>
          
          ${privateCount > 0 ? `
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(156, 39, 176, 0.2); color: #9c27b0;">
              <i class="fas fa-building"></i>
            </div>
            <div class="cluster-stat-value">${privateCount}</div>
            <div class="cluster-stat-label">Private</div>
          </div>
          ` : ''}
          
          <!-- Second row: tiers -->
          ${vipCount > 0 ? `
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(255, 69, 0, 0.2); color: #ff4500;">
              <i class="fas fa-crown"></i>
            </div>
            <div class="cluster-stat-value">${vipCount}</div>
            <div class="cluster-stat-label">VIP</div>
          </div>
          ` : ''}
          
          ${platinumCount > 0 ? `
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(229, 228, 226, 0.5); color: #6c757d;">
              <i class="fas fa-medal"></i>
            </div>
            <div class="cluster-stat-value">${platinumCount}</div>
            <div class="cluster-stat-label">Platinum</div>
          </div>
          ` : ''}
          
          ${goldCount > 0 ? `
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(255, 215, 0, 0.2); color: #ffc107;">
              <i class="fas fa-award"></i>
            </div>
            <div class="cluster-stat-value">${goldCount}</div>
            <div class="cluster-stat-label">Gold</div>
          </div>
          ` : ''}
          
          ${silverCount > 0 ? `
          <div class="cluster-stat">
            <div class="cluster-stat-icon" style="background-color: rgba(192, 192, 192, 0.3); color: #6c757d;">
              <i class="fas fa-certificate"></i>
            </div>
            <div class="cluster-stat-value">${silverCount}</div>
            <div class="cluster-stat-label">Silver</div>
          </div>
          ` : ''}
        </div>
        
        <div style="text-align: center; margin-top: 15px;">
          <button id="zoom-to-cluster" style="background-color: #007bff; color: white; 
                 border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;
                 font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
            <i class="fas fa-search-plus"></i> Zoom In
          </button>
        </div>
      </div>
      `;
      
      return html;
    }

    // Fixed: Map style radio buttons with event handlers to persist markers
    const layerIds = ['streets-v11', 'light-v10', 'dark-v10', 'satellite-v9'];
    layerIds.forEach(layerId => {
      document.getElementById(layerId).addEventListener('change', function() {
        // Store current map center and zoom level
        const center = map.getCenter();
        const zoom = map.getZoom();
        const currentStyle = 'mapbox://styles/mapbox/' + layerId;
        
        // Store current markers data
        const savedData = rawData; 
        
        // Set the flag to indicate style change is happening
        console.log(`Changing map style to: ${layerId}`);
        currentMapStyle = layerId;
        
        // Change map style
        map.setStyle(currentMapStyle);
        
        // Set up a listener for the style.load event
        map.once('style.load', function() {
          console.log('Style loaded, recreating markers');
          
          // Re-add the markers after the style has changed
          if (savedData && savedData.length > 0) {
            // Re-use the existing data to recreate markers
            setTimeout(() => {
              console.log('Recreating markers with saved data');
              createDirectMarkers(savedData);
              
              // Restore view
              map.setCenter(center);
              map.setZoom(zoom);
            }, 500);
          }
        });
      });
    });
  </script>
</body>
</html>
