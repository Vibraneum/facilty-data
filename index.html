<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ixora Facility Management - Police Stations Hyderabad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MAPBOX GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    :root {
      --primary-color: #0056b3;
      --primary-light: #007bff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --body-bg: #f8f9fa;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition-speed: 0.3s;
      --primary-light-rgb: 0, 123, 255;

      /* Category colors */
      --vip-color: #ff4500;
      --platinum-color: #e5e4e2;
      --gold-color: #ffd700;
      --silver-color: #c0c0c0;

      /* Site type colors */
      --hyderabad-color: #3366cc;
      --cyberabad-color: #0099c6;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--body-bg);
      color: var(--dark-color);
    }

    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .header {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
      padding: 15px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      max-width: 90%;
      text-align: center;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .header img {
      height: 40px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
    }
    .header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .sidebar {
      position: absolute;
      top: 80px;
      left: 20px;
      bottom: 20px;
      width: 300px;
      z-index: 1000;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow-y: auto;
      transition: transform var(--transition-speed), background-color var(--transition-speed);
      transform: translateX(0);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .sidebar-content {
      padding: 20px;
    }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background-color: var(--primary-light);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 10;
      transition: transform 0.2s ease;
    }
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    .sidebar.collapsed {
      transform: translateX(-340px);
    }

    .filter-section {
      margin-bottom: 24px;
    }
    .filter-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      transition: color var(--transition-speed);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-section h3 i {
      color: var(--primary-light);
    }
    .checkbox-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.2s ease;
    }
    .checkbox-item:hover {
      transform: translateX(5px);
    }
    .custom-checkbox {
      position: relative;
      display: flex;
      align-items: center;
    }
    .custom-checkbox input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    .checkmark {
      height: 20px;
      width: 20px;
      background-color: #eee;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .custom-checkbox:hover input ~ .checkmark {
      background-color: #ccc;
    }
    .custom-checkbox input:checked ~ .checkmark {
      background-color: var(--primary-light);
    }
    .checkmark:after {
      content: "\f00c";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      display: none;
      font-size: 12px;
    }
    .custom-checkbox input:checked ~ .checkmark:after {
      display: block;
    }

    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #search-bar {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      background-color: var(--light-color);
      color: var(--dark-color);
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    #search-bar:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(var(--primary-light-rgb), 0.25);
    }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary-color);
    }
    /* Repositioned Legend */
    .legend {
      /* Legend styles - improved positioning and interaction */
      position: absolute;
      bottom: 90px; /* Moved up to avoid overlap with map controls */
      right: 20px;
      z-index: 900; /* Lower than map controls (1000) */
      background-color: var(--card-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .legend h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--dark-color);
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
    }

    /* Add legend minimize button */
    .legend-minimize {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--light-color);
      color: var(--dark-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s ease;
    }

    .legend-minimize:hover {
      background-color: var(--primary-light);
      color: white;
    }

    .legend.minimized {
      transform: translateY(calc(100% - 40px));
      height: 40px;
      max-height: 40px;
      overflow: hidden;
    }

    .legend.minimized h3 {
      margin: 0;
      padding: 0;
      border: none;
    }

    .legend.minimized .legend-section {
      display: none;
    }

    .legend-section {
      margin-bottom: 15px;
    }

    .legend-item,
    .legend-tier-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      transition: transform 0.2s ease;
    }
    .legend-item:hover,
    .legend-tier-item:hover {
      transform: translateX(5px);
    }

    .legend-color,
    .legend-tier-icon {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      flex-shrink: 0;
      transition: transform 0.2s ease;
      border: 2px solid white;
    }
    .legend-color:hover,
    .legend-tier-icon:hover {
      transform: scale(1.1);
    }

    .type-hyderabad-police { background-color: var(--hyderabad-color); }
    .type-cyberabad-police { background-color: var(--cyberabad-color); }

    .tier-vip {
      background: linear-gradient(135deg, var(--vip-color), #ff6347);
      color: white;
    }
    .tier-platinum {
      background: linear-gradient(135deg, var(--platinum-color), #ffffff);
      color: #333;
    }
    .tier-gold {
      background: linear-gradient(135deg, var(--gold-color), #FFF7CC);
      color: #333;
    }
    .tier-silver {
      background: linear-gradient(135deg, var(--silver-color), #E6E6E6);
      color: #333;
    }

    /* Improve map controls positioning to avoid overlap with legend */
    .mapboxgl-ctrl-top-right {
      top: 20px !important;
      right: 20px !important;
    }
    .mapboxgl-ctrl-bottom-right {
      bottom: 20px !important;
      right: 20px !important;
    }

    /* Custom Popup styling */
    .custom-popup {
      max-width: 350px;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      color: var(--dark-color);
    }
    .custom-popup h3 {
      margin: 0 0 12px 0;
      color: var(--dark-color);
      font-size: 18px;
      border-bottom: 2px solid var(--primary-light);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .site-type-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      margin-right: 10px;
      flex-shrink: 0;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .popup-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .popup-stat-card {
      background-color: rgba(var(--primary-light-rgb), 0.1);
      border-radius: var(--border-radius);
      padding: 12px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(var(--primary-light-rgb), 0.2);
    }
    .popup-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .popup-stat-icon {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--primary-light);
    }
    .popup-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--dark-color);
    }
    .popup-stat-label {
      font-size: 12px;
      color: var(--secondary-color);
      margin-top: 3px;
    }

    .popup-header-info {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .popup-tier-badge {
      background-color: var(--light-color);
      border-radius: 20px;
      padding: 3px 8px;
      font-size: 12px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: auto;
    }
    .popup-tier-badge.vip {
      background-color: var(--vip-color);
      color: white;
    }
    .popup-tier-badge.platinum {
      background-color: var(--platinum-color);
      color: #333;
    }
    .popup-tier-badge.gold {
      background-color: var(--gold-color);
      color: #333;
    }
    .popup-tier-badge.silver {
      background-color: var(--silver-color);
      color: #333;
    }

    .popup-address {
      background-color: rgba(var(--primary-light-rgb), 0.05);
      padding: 12px;
      border-radius: var(--border-radius);
      margin-top: 10px;
      font-size: 14px;
      border-left: 3px solid var(--primary-light);
    }
    .popup-address i {
      color: var(--primary-light);
      margin-right: 5px;
    }

    .loader-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-light);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
      margin-bottom: 15px;
    }
    .loader-text {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 500;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Custom Mapbox marker styles */
    .mapboxgl-marker {
      transition: transform 0.3s ease;
    }
    .mapboxgl-marker:hover {
      transform: scale(1.2);
    }
    .custom-marker {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      border: 2px solid white;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .custom-marker:hover {
      transform: scale(1.2);
    }
    .custom-marker.hyderabad-police {
      background-color: var(--hyderabad-color);
    }
    .custom-marker.cyberabad-police {
      background-color: var(--cyberabad-color);
    }
    .custom-marker.vip::after,
    .custom-marker.platinum::after,
    .custom-marker.gold::after,
    .custom-marker.silver::after {
      content: "";
      position: absolute;
      top: -5px;
      right: -5px;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      border: 2px solid white;
    }
    .custom-marker.vip::after {
      background-color: var(--vip-color);
    }
    .custom-marker.platinum::after {
      background-color: var(--platinum-color);
    }
    .custom-marker.gold::after {
      background-color: var(--gold-color);
    }
    .custom-marker.silver::after {
      background-color: var(--silver-color);
    }

    /* Status indicator */
    .status-indicator {
      position: absolute;
      bottom: 20px;
      left: 20px;
      padding: 10px 15px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .status-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .status-indicator i {
      color: var(--success-color);
    }
    .status-indicator.error i {
      color: var(--danger-color);
    }

    /* Responsive & smaller screens */
    @media (max-width: 768px) {
      .header {
        width: calc(100% - 40px);
        padding: 10px 15px;
      }
      .sidebar {
        width: 250px;
      }
      .legend {
        bottom: 10px;
        right: 10px;
        width: 200px;
      }
    }
    @media (max-width: 576px) {
      .header h1 {
        font-size: 16px;
      }
      .header img {
        height: 30px;
      }
      .sidebar.collapsed {
        transform: translateX(-240px);
      }
    }
  </style>
</head>
<body>
    <div id="map-container">
      <!-- Loader -->
      <div class="loader-container" id="loader">
        <div class="loader"></div>
        <div class="loader-text">Loading facility data...</div>
      </div>
  
      <!-- Header -->
      <div class="header">
        <img src="https://raw.githubusercontent.com/Vibraneum/facilty-data/refs/heads/main/Ixora%20FM%20logo.png" alt="Ixora FM Logo">
        <h1>Ixora Facility Management - Police Stations Hyderabad</h1>
      </div>
  
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" id="sidebar-toggle">
          <i class="fas fa-chevron-left"></i>
        </div>
        <div class="sidebar-content">
          <div class="search-container">
            <input type="text" id="search-bar" placeholder="Search by site name...">
            <span class="search-icon"><i class="fas fa-search"></i></span>
          </div>
  
          <div class="filter-section">
            <h3><i class="fas fa-filter"></i> Site Types</h3>
            <div class="checkbox-container">
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="hyderabad-police" checked data-type="hyderabad-police"/>
                  <span class="checkmark"></span>
                </label>
                <span>Hyderabad Police</span>
              </div>
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="cyberabad-police" checked data-type="cyberabad-police"/>
                  <span class="checkmark"></span>
                </label>
                <span>Cyberabad Police</span>
              </div>
            </div>
          </div>
  
          <div class="filter-section">
            <h3><i class="fas fa-medal"></i> Site Category</h3>
            <div class="checkbox-container">
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="vip-tier" checked data-tier="vip"/>
                  <span class="checkmark"></span>
                </label>
                <span>VIP</span>
              </div>
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="platinum-tier" checked data-tier="platinum"/>
                  <span class="checkmark"></span>
                </label>
                <span>Platinum</span>
              </div>
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="gold-tier" checked data-tier="gold"/>
                  <span class="checkmark"></span>
                </label>
                <span>Gold</span>
              </div>
              <div class="checkbox-item">
                <label class="custom-checkbox">
                  <input type="checkbox" id="silver-tier" checked data-tier="silver"/>
                  <span class="checkmark"></span>
                </label>
                <span>Silver</span>
              </div>
            </div>
          </div>
          
          <div class="filter-section">
            <h3><i class="fas fa-info-circle"></i> Statistics</h3>
            <div id="stats-container">
              Loading statistics...
            </div>
          </div>
        </div>
      </div>
  
      <!-- Legend -->
      <div class="legend" id="legend">
        <div class="legend-section">
          <h3>Site Types</h3>
          <div class="legend-item">
            <div class="legend-color type-hyderabad-police">
              <i class="fas fa-shield-alt"></i>
            </div>
            <span>Hyderabad Police</span>
          </div>
          <div class="legend-item">
            <div class="legend-color type-cyberabad-police">
              <i class="fas fa-laptop-code"></i>
            </div>
            <span>Cyberabad Police</span>
          </div>
        </div>
        <div class="legend-section">
          <h3>Site Categories</h3>
          <div class="legend-tier-item">
            <div class="legend-tier-icon tier-vip">V</div>
            <span>VIP Tier</span>
          </div>
          <div class="legend-tier-item">
            <div class="legend-tier-icon tier-platinum">P</div>
            <span>Platinum Tier</span>
          </div>
          <div class="legend-tier-item">
            <div class="legend-tier-icon tier-gold">G</div>
            <span>Gold Tier</span>
          </div>
          <div class="legend-tier-item">
            <div class="legend-tier-icon tier-silver">S</div>
            <span>Silver Tier</span>
          </div>
        </div>
      </div>
      
      <!-- Status Indicator -->
      <div class="status-indicator" id="status-indicator">
        <i class="fas fa-check-circle"></i>
        <span id="status-text">Data loaded successfully</span>
      </div>
  
      <div id="map"></div>
    </div>

    <script>
      // Use your actual Mapbox token
      mapboxgl.accessToken = 'pk.eyJ1IjoidmVkYW50aG5hdGgiLCJhIjoiY203c3lsOWZyMGs4MzJpcmJoZTY1Ync4bSJ9.Hx83V0-qM8JOmh4y_SSXCw';
  
      // Create the map
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [78.4867, 17.3850], // Hyderabad
        zoom: 11,
        pitch: 15,
        bearing: 0
      });
  
      // UI Elements
      const loader = document.getElementById('loader');
      const sidebar = document.getElementById('sidebar');
      const sidebarTgl = document.getElementById('sidebar-toggle');
      const searchBar = document.getElementById('search-bar');
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const statsContainer = document.getElementById('stats-container');
  
      let rawData = null;
      let currentPopup = null; 
      let markers = [];       
      let visibleMarkers = []; 
  
      // Sample VIP data for demonstration
      const sampleVIPData = {
        "Saifabad": { staff: 45, supervisors: 5, managers: 2, area: "12,500 sq ft", chemicals: 12, wasteVehicles: 4, machines: 15 },
        "Begumpet": { staff: 38, supervisors: 4, managers: 1, area: "10,200 sq ft", chemicals: 9, wasteVehicles: 3, machines: 12 },
        "Charminar": { staff: 52, supervisors: 6, managers: 2, area: "15,800 sq ft", chemicals: 15, wasteVehicles: 5, machines: 18 },
        "Jubilee Hills": { staff: 41, supervisors: 5, managers: 2, area: "11,600 sq ft", chemicals: 11, wasteVehicles: 4, machines: 14 },
        "Gachibowli": { staff: 35, supervisors: 3, managers: 1, area: "9,800 sq ft", chemicals: 8, wasteVehicles: 3, machines: 10 },
        "Kukatpally": { staff: 47, supervisors: 5, managers: 2, area: "13,200 sq ft", chemicals: 13, wasteVehicles: 4, machines: 16 }
      };
  
      map.on('load', () => {
        // Add controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true
          }),
          'top-right'
        );
  
        fetchDataAndBuildLayers();
      });
  
      function fetchDataAndBuildLayers() {
        showStatus('Loading facility data...', 'loading');
  
        // Fetch your facilities JSON here:
        fetch('facilities.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            rawData = data;
            buildGeoJSONClusters(rawData);
            loader.style.display = 'none';
            showStatus(`Data loaded successfully (${rawData.length} facilities)`, 'success');
          })
          .catch(err => {
            console.error('Fetch error:', err);
            showStatus(`Failed to fetch: ${err.message}`, 'error');
            // Fallback to sample data
            rawData = generateSampleData();
            buildGeoJSONClusters(rawData);
            loader.style.display = 'none';
          });
      }
  
      // Convert array => GeoJSON, set up clustering layers
      function buildGeoJSONClusters(arrayData) {
        // Convert to GeoJSON
        const geojsonData = {
          type: 'FeatureCollection',
          features: arrayData.map(item => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
            },
            properties: { ...item }
          }))
        };
  
        // Add source
        map.addSource('facilities', {
          type: 'geojson',
          data: geojsonData,
          cluster: true,
          clusterMaxZoom: 14,
          clusterRadius: 50,
          clusterProperties: {
            hyderabad_count: ['+', ['case', ['==', ['get', 'type'], 'hyderabad-police'], 1, 0]],
            cyberabad_count: ['+', ['case', ['==', ['get', 'type'], 'cyberabad-police'], 1, 0]],
            vip_count: ['+', ['case', ['==', ['get', 'tier'], 'vip'], 1, 0]],
            platinum_count: ['+', ['case', ['==', ['get', 'tier'], 'platinum'], 1, 0]],
            gold_count: ['+', ['case', ['==', ['get', 'tier'], 'gold'], 1, 0]],
            silver_count: ['+', ['case', ['==', ['get', 'tier'], 'silver'], 1, 0]]
          }
        });
  
        // Clusters
        map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'facilities',
          filter: ['has', 'point_count'],
          paint: {
            'circle-radius': [
              'step', ['get', 'point_count'],
              20, 5, 25, 10, 30, 20, 35
            ],
            'circle-color': [
              'case',
              ['>', ['get', 'hyderabad_count'], ['get', 'cyberabad_count']],
              'var(--hyderabad-color)',
              'var(--cyberabad-color)'
            ],
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff'
          }
        });
  
        // Cluster count
        map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'facilities',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': '{point_count_abbreviated}',
            'text-size': 14,
            'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold']
          },
          paint: {
            'text-color': '#ffffff'
          }
        });
  
        // Unclustered points
        map.addLayer({
          id: 'unclustered-point',
          type: 'circle',
          source: 'facilities',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-radius': 12,
            'circle-color': [
              'match',
              ['get', 'type'],
              'hyderabad-police', 'var(--hyderabad-color)',
              'cyberabad-police', 'var(--cyberabad-color)',
              '#ccc'
            ],
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff'
          }
        });
  
        // Unclustered labels
        map.addLayer({
          id: 'unclustered-label',
          type: 'symbol',
          source: 'facilities',
          filter: ['!', ['has', 'point_count']],
          layout: {
            'text-field': [
              'match',
              ['get', 'type'],
              'hyderabad-police', 'H',
              'cyberabad-police', 'C',
              'X'
            ],
            'text-size': 10,
            'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold']
          },
          paint: {
            'text-color': '#ffffff'
          }
        });
  
        // Tier indicator ring
        map.addLayer({
          id: 'tier-indicator',
          type: 'circle',
          source: 'facilities',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-radius': 6,
            'circle-color': [
              'match',
              ['get', 'tier'],
              'vip', 'var(--vip-color)',
              'platinum', 'var(--platinum-color)',
              'gold', 'var(--gold-color)',
              'silver', 'var(--silver-color)',
              '#ccc'
            ],
            'circle-stroke-width': 1,
            'circle-stroke-color': '#ffffff',
            'circle-translate': [10, -10]
          }
        });
  
        setupMapInteraction();
        updateStats(arrayData);
        fitBoundsToSource('facilities');
      }
  
      // Map interactions (click cluster => popup; click point => popup)
      function setupMapInteraction() {
        // Click cluster
        map.on('click', 'clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
          if (!features.length) return;
          const clusterId = features[0].properties.cluster_id;
          map.getSource('facilities').getClusterExpansionZoom(clusterId, (err, zoom) => {
            if (err) return;
            const coords = features[0].geometry.coordinates.slice();
            const props = features[0].properties;
            const popupContent = `
              <div class="custom-popup">
                <h3>Cluster Details</h3>
                <div class="popup-stats-grid">
                  ${buildStatCard('fa-shield-alt', props.hyderabad_count || 0, 'Hyderabad')}
                  ${buildStatCard('fa-laptop-code', props.cyberabad_count || 0, 'Cyberabad')}
                  ${buildStatCard('fa-crown', props.vip_count || 0, 'VIP')}
                  ${buildStatCard('fa-medal', props.platinum_count || 0, 'Platinum')}
                  ${buildStatCard('fa-award', props.gold_count || 0, 'Gold')}
                  ${buildStatCard('fa-certificate', props.silver_count || 0, 'Silver')}
                </div>
                <div style="text-align: center; margin-top: 10px;">
                  <button id="zoom-to-cluster" style="background-color: var(--primary-light); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-search-plus"></i> Zoom In
                  </button>
                </div>
              </div>
            `;
            if (currentPopup) currentPopup.remove();
            currentPopup = new mapboxgl.Popup({ offset: 25, closeButton: true, maxWidth: '350px' })
              .setLngLat(coords)
              .setHTML(popupContent)
              .addTo(map);
  
            setTimeout(() => {
              const zoomBtn = document.getElementById('zoom-to-cluster');
              if (zoomBtn) {
                zoomBtn.addEventListener('click', () => {
                  currentPopup.remove();
                  map.flyTo({ center: coords, zoom: zoom + 1, duration: 1000 });
                });
              }
            }, 50);
          });
        });
        map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
  
        // Click unclustered point
        map.on('click', 'unclustered-point', (e) => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['unclustered-point'] });
          if (!features.length) return;
          const props = features[0].properties;
          const coords = features[0].geometry.coordinates.slice();
          const popupContent = createFacilityPopupHTML(props);
          if (currentPopup) currentPopup.remove();
          currentPopup = new mapboxgl.Popup({ offset: 25, closeButton: true, closeOnClick: true, maxWidth: '350px' })
            .setLngLat(coords)
            .setHTML(popupContent)
            .addTo(map);
        });
        map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });
      }
  
      // Build popup HTML
      function createFacilityPopupHTML(props) {
        const sqFt = parseInt(props.squareFeet) || 0;
        const staff = parseInt(props.staff) || 0;
        const chemicals = parseInt(props.chemicals) || 0;
        const wasteVehicles = parseInt(props.wasteVehicles) || 0;
        const machines = parseInt(props.machines) || 0;
        const siteName = props.siteName || 'Unknown Site';
        const siteType = props.type || 'unknown';
        const siteTier = props.tier || 'unknown';
  
        let html = `<div class="custom-popup">`;
        html += `
          <div class="popup-header-info">
            <span class="site-type-icon ${
              siteType === 'hyderabad-police' ? 'type-hyderabad-police' :
              siteType === 'cyberabad-police' ? 'type-cyberabad-police' : ''
            }">
              ${
                siteType === 'hyderabad-police' ? '<i class="fas fa-shield-alt"></i>' :
                siteType === 'cyberabad-police' ? '<i class="fas fa-laptop-code"></i>' :
                '<i class="fas fa-map-marker-alt"></i>'
              }
            </span>
            <h3>${siteName}</h3>
            <span class="popup-tier-badge ${siteTier}">
              ${
                siteTier === 'vip' ? '<i class="fas fa-crown"></i> VIP' :
                siteTier === 'platinum' ? '<i class="fas fa-medal"></i> Platinum' :
                siteTier === 'gold' ? '<i class="fas fa-award"></i> Gold' :
                '<i class="fas fa-certificate"></i> Silver'
              }
            </span>
          </div>
        `;
        // If VIP, show details
        if (siteTier === 'vip') {
          html += `<div class="popup-stats-grid">`;
          html += buildStatCard('fa-chart-area', formatNumber(sqFt)+' sq ft', 'Area');
          if (staff) html += buildStatCard('fa-user', staff, 'Staff');
          if (chemicals) html += buildStatCard('fa-flask', chemicals, 'Chemicals');
          if (wasteVehicles) html += buildStatCard('fa-truck', wasteVehicles, 'Waste Veh');
          if (machines) html += buildStatCard('fa-cogs', machines, 'Machines');
          html += `</div>`;
        } else {
          html += `<p><strong>Square Feet:</strong> ${formatNumber(sqFt)} sq ft</p>`;
        }
        // Address
        if (props.address) {
          html += `<div class="popup-address"><i class="fas fa-map-marker-alt"></i> ${props.address}</div>`;
        }
        html += `</div>`;
        return html;
      }
  
      // Build a stat card
      function buildStatCard(iconClass, value, label) {
        return `
          <div class="popup-stat-card">
            <div class="popup-stat-icon"><i class="fas ${iconClass}"></i></div>
            <div class="popup-stat-value">${value}</div>
            <div class="popup-stat-label">${label}</div>
          </div>
        `;
      }
  
      function formatNumber(num) {
        if (!num) return 'N/A';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
  
      // Fit bounds to all source points
      function fitBoundsToSource(sourceName) {
        const sourceFeatures = map.querySourceFeatures(sourceName);
        if (!sourceFeatures.length) {
          map.flyTo({ center: [78.4867, 17.3850], zoom: 11 });
          return;
        }
        const bounds = new mapboxgl.LngLatBounds();
        sourceFeatures.forEach(f => {
          if (f.geometry && f.geometry.type === 'Point') {
            bounds.extend(f.geometry.coordinates);
          }
        });
        map.fitBounds(bounds, {
          padding: { top: 100, bottom: 100, left: 350, right: 50 },
          maxZoom: 14,
          duration: 1000
        });
      }
  
      // Generate fallback sample data
      function generateSampleData() {
        return [
          { siteName: "Saifabad PS", latitude: 17.4010, longitude: 78.4730, type: "hyderabad-police", tier: "vip", squareFeet: 12500, address: "5-8-207/2, Saifabad, Hyderabad-500004" },
          { siteName: "Begumpet PS", latitude: 17.4440, longitude: 78.4680, type: "hyderabad-police", tier: "vip", squareFeet: 10200, address: "Behind Shoppers Stop, Begumpet, Hyderabad-500016" },
          { siteName: "Charminar PS", latitude: 17.3616, longitude: 78.4747, type: "hyderabad-police", tier: "vip", squareFeet: 15800, address: "Near Charminar Bus Stand, Hyderabad-500002" },
          { siteName: "Jubilee Hills PS", latitude: 17.4319, longitude: 78.4073, type: "hyderabad-police", tier: "platinum", squareFeet: 11600, address: "Road No. 10, Jubilee Hills, Hyderabad-500033" },
          { siteName: "Gachibowli PS", latitude: 17.4438, longitude: 78.3515, type: "cyberabad-police", tier: "platinum", squareFeet: 9800, address: "Financial District, Gachibowli, Hyderabad-500032" },
          { siteName: "Kukatpally PS", latitude: 17.4849, longitude: 78.4117, type: "cyberabad-police", tier: "gold", squareFeet: 13200, address: "Near JNTU, Kukatpally, Hyderabad-500085" },
          { siteName: "Uppal PS", latitude: 17.4034, longitude: 78.5592, type: "hyderabad-police", tier: "gold", squareFeet: 8700, address: "Uppal X Roads, Hyderabad-500039" },
          { siteName: "Miyapur PS", latitude: 17.4990, longitude: 78.3720, type: "cyberabad-police", tier: "silver", squareFeet: 7800, address: "Miyapur X Roads, Hyderabad-500049" },
          { siteName: "Madhapur PS", latitude: 17.4500, longitude: 78.3900, type: "cyberabad-police", tier: "silver", squareFeet: 9500, address: "Near Cyber Towers, Madhapur, Hyderabad-500081" },
          { siteName: "LB Nagar PS", latitude: 17.3521, longitude: 78.5472, type: "hyderabad-police", tier: "silver", squareFeet: 8200, address: "LB Nagar Circle, Hyderabad-500074" }
        ];
      }
  
      // Update statistics
      function updateStats(data) {
        if (!data || !Array.isArray(data)) {
          statsContainer.innerHTML = '<p>No statistics available</p>';
          return;
        }
        const typeCount = { 'hyderabad-police': 0, 'cyberabad-police': 0 };
        const tierCount = { vip: 0, platinum: 0, gold: 0, silver: 0 };
        data.forEach(item => {
          if (item.type) typeCount[item.type] = (typeCount[item.type] || 0) + 1;
          if (item.tier) tierCount[item.tier] = (tierCount[item.tier] || 0) + 1;
        });
        const html = `
          <div style="font-size: 14px; line-height: 1.6;">
            <p><strong>Total Facilities:</strong> ${data.length}</p>
            <p><strong>Types:</strong>
              Hyderabad (${typeCount['hyderabad-police'] || 0}),
              Cyberabad (${typeCount['cyberabad-police'] || 0})
            </p>
            <p><strong>Categories:</strong><br>
              <span style="color: var(--vip-color);"><i class="fas fa-crown"></i> VIP:</span> ${tierCount['vip'] || 0}<br>
              <span style="color: #6c757d;"><i class="fas fa-medal"></i> Platinum:</span> ${tierCount['platinum'] || 0}<br>
              <span style="color: #6c757d;"><i class="fas fa-award"></i> Gold:</span> ${tierCount['gold'] || 0}<br>
              <span style="color: #6c757d;"><i class="fas fa-certificate"></i> Silver:</span> ${tierCount['silver'] || 0}
            </p>
          </div>
        `;
        statsContainer.innerHTML = html;
      }
  
      // Show a status message
      function showStatus(message, type = 'info') {
        statusText.textContent = message;
        statusIndicator.className = 'status-indicator';
        if (type === 'error') {
          statusIndicator.classList.add('error');
          statusIndicator.querySelector('i').className = 'fas fa-exclamation-circle';
        } else if (type === 'loading') {
          statusIndicator.querySelector('i').className = 'fas fa-spinner fa-spin';
        } else {
          statusIndicator.querySelector('i').className = 'fas fa-check-circle';
        }
        statusIndicator.classList.add('visible');
        if (type !== 'loading') {
          setTimeout(() => {
            statusIndicator.classList.remove('visible');
          }, 5000);
        }
      }
  
      // Sidebar toggle
      sidebarTgl.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        const icon = sidebarTgl.querySelector('i');
        if (sidebar.classList.contains('collapsed')) {
          icon.classList.remove('fa-chevron-left');
          icon.classList.add('fa-chevron-right');
        } else {
          icon.classList.remove('fa-chevron-right');
          icon.classList.add('fa-chevron-left');
        }
      });
  
      // We’re not using markers array because we rely on Mapbox’s cluster approach
      // But you can add additional logic for filtering if needed
  
      // Simple search could be implemented with your data source, but requires reloading or re-filtering layers
      // For advanced filtering in cluster-based approaches, you'd manage a separate unclustered source or re-generate the cluster source with filters
  
    </script>
  </body>
  </html>
  
